(function(e){if(typeof exports=="object"&&typeof module=="object")e(require("../../lib/codemirror"));else if(typeof define=="function"&&define.amd)define(["../../lib/codemirror"],e);else e(CodeMirror)})(function(e){"use strict";function r(e,t,n){this.cm=e;this.getHints=t;this.options=n;this.widget=this.onClose=null}function i(e){if(typeof e=="string")return e;else return e.text}function s(e,t){function i(e,i){var s;if(typeof i!="string")s=function(e){return i(e,t)};else if(n.hasOwnProperty(i))s=n[i];else s=i;r[e]=s}var n={Up:function(){t.moveFocus(-1)},Down:function(){t.moveFocus(1)},PageUp:function(){t.moveFocus(-t.menuSize()+1,true)},PageDown:function(){t.moveFocus(t.menuSize()-1,true)},Home:function(){t.setFocus(0)},End:function(){t.setFocus(t.length-1)},Enter:t.pick,Tab:t.pick,Esc:t.close};var r=e.customKeys?{}:n;if(e.customKeys)for(var s in e.customKeys)if(e.customKeys.hasOwnProperty(s))i(s,e.customKeys[s]);if(e.extraKeys)for(var s in e.extraKeys)if(e.extraKeys.hasOwnProperty(s))i(s,e.extraKeys[s]);return r}function o(e,t){while(t&&t!=e){if(t.nodeName.toUpperCase()==="LI"&&t.parentNode==e)return t;t=t.parentNode}}function u(r,u){this.completion=r;this.data=u;var a=this,f=r.cm,l=r.options;var c=this.hints=document.createElement("ul");c.className="CodeMirror-hints";this.selectedHint=l.getDefaultSelection?l.getDefaultSelection(f,l,u):0;var h=u.list;for(var p=0;p<h.length;++p){var d=c.appendChild(document.createElement("li")),v=h[p];var m=t+(p!=this.selectedHint?"":" "+n);if(v.className!=null)m=v.className+" "+m;d.className=m;if(v.render)v.render(d,u,v);else d.appendChild(document.createTextNode(v.displayText||i(v)));d.hintId=p}var g=f.cursorCoords(l.alignWithWord!==false?u.from:null);var y=g.left,b=g.bottom,w=true;c.style.left=y+"px";c.style.top=b+"px";var E=window.innerWidth||Math.max(document.body.offsetWidth,document.documentElement.offsetWidth);var S=window.innerHeight||Math.max(document.body.offsetHeight,document.documentElement.offsetHeight);(l.container||document.body).appendChild(c);var x=c.getBoundingClientRect(),T=x.bottom-S;if(T>0){var N=x.bottom-x.top,C=x.top-(g.bottom-g.top);if(C-N>0){c.style.top=(b=C-N)+"px";w=false}else if(N>S){c.style.height=S-5+"px";c.style.top=(b=g.bottom-x.top)+"px";var k=f.getCursor();if(u.from.ch!=k.ch){g=f.cursorCoords(k);c.style.left=(y=g.left)+"px";x=c.getBoundingClientRect()}}}var L=x.left-E;if(L>0){if(x.right-x.left>E){c.style.width=E-5+"px";L-=x.right-x.left-E}c.style.left=(y=g.left-L)+"px"}f.addKeyMap(this.keyMap=s(l,{moveFocus:function(e,t){a.changeActive(a.selectedHint+e,t)},setFocus:function(e){a.changeActive(e)},menuSize:function(){return a.screenAmount()},length:h.length,close:function(){r.close()},pick:function(){a.pick()},data:u}));if(l.closeOnUnfocus!==false){var A;f.on("blur",this.onBlur=function(){A=setTimeout(function(){r.close()},100)});f.on("focus",this.onFocus=function(){clearTimeout(A)})}var O=f.getScrollInfo();f.on("scroll",this.onScroll=function(){var e=f.getScrollInfo(),t=f.getWrapperElement().getBoundingClientRect();var n=b+O.top-e.top;var i=n-(window.pageYOffset||(document.documentElement||document.body).scrollTop);if(!w)i+=c.offsetHeight;if(i<=t.top||i>=t.bottom)return r.close();c.style.top=n+"px";c.style.left=y+O.left-e.left+"px"});e.on(c,"dblclick",function(e){var t=o(c,e.target||e.srcElement);if(t&&t.hintId!=null){a.changeActive(t.hintId);a.pick()}});e.on(c,"click",function(e){var t=o(c,e.target||e.srcElement);if(t&&t.hintId!=null){a.changeActive(t.hintId);if(l.completeOnSingleClick)a.pick()}});e.on(c,"mousedown",function(){setTimeout(function(){f.focus()},20)});e.signal(u,"select",h[0],c.firstChild);return true}var t="CodeMirror-hint";var n="CodeMirror-hint-active";e.showHint=function(t,n,i){if(t.listSelections().length>1||t.somethingSelected())return;if(n==null){if(i&&i.async)return;else n=e.hint.auto}if(t.state.completionActive)t.state.completionActive.close();var s=t.state.completionActive=new r(t,n,i||{});e.signal(t,"startCompletion",t);if(s.options.async)n(t,function(e){s.showHints(e)},s.options);else return s.showHints(n(t,s.options))};r.prototype={close:function(){if(!this.active())return;this.cm.state.completionActive=null;if(this.widget)this.widget.close();if(this.onClose)this.onClose();e.signal(this.cm,"endCompletion",this.cm)},active:function(){return this.cm.state.completionActive==this},pick:function(t,n){var r=t.list[n];if(r.hint)r.hint(this.cm,t,r);else this.cm.replaceRange(i(r),r.from||t.from,r.to||t.to,"complete");e.signal(t,"pick",r);this.close()},showHints:function(e){if(!e||!e.list.length||!this.active())return this.close();if(this.options.completeSingle!=false&&e.list.length==1)this.pick(e,0);else this.showWidget(e)},showWidget:function(t){function c(){if(i)return;i=true;r.close();r.cm.off("cursorActivity",v);if(t)e.signal(t,"close")}function h(){if(i)return;e.signal(t,"update");if(r.options.async)r.getHints(r.cm,p,r.options);else p(r.getHints(r.cm,r.options))}function p(e){t=e;if(i)return;if(!t||!t.list.length)return c();if(r.widget)r.widget.close();r.widget=new u(r,t)}function d(){if(n){l(n);n=0}}function v(){d();var e=r.cm.getCursor(),t=r.cm.getLine(e.line);if(e.line!=o.line||t.length-e.ch!=a-o.ch||e.ch<o.ch||r.cm.somethingSelected()||e.ch&&s.test(t.charAt(e.ch-1))){r.close()}else{n=f(h);if(r.widget)r.widget.close()}}this.widget=new u(this,t);e.signal(t,"shown");var n=0,r=this,i;var s=this.options.closeCharacters||/[\s()\[\]{};:>,]/;var o=this.cm.getCursor(),a=this.cm.getLine(o.line).length;var f=window.requestAnimationFrame||function(e){return setTimeout(e,1e3/60)};var l=window.cancelAnimationFrame||clearTimeout;this.cm.on("cursorActivity",v);this.onClose=c}};u.prototype={close:function(){if(this.completion.widget!=this)return;this.completion.widget=null;this.hints.parentNode.removeChild(this.hints);this.completion.cm.removeKeyMap(this.keyMap);var e=this.completion.cm;if(this.completion.options.closeOnUnfocus!==false){e.off("blur",this.onBlur);e.off("focus",this.onFocus)}e.off("scroll",this.onScroll)},pick:function(){this.completion.pick(this.data,this.selectedHint)},changeActive:function(t,r){if(t>=this.data.list.length)t=r?this.data.list.length-1:0;else if(t<0)t=r?0:this.data.list.length-1;if(this.selectedHint==t)return;var i=this.hints.childNodes[this.selectedHint];i.className=i.className.replace(" "+n,"");i=this.hints.childNodes[this.selectedHint=t];i.className+=" "+n;if(i.offsetTop<this.hints.scrollTop)this.hints.scrollTop=i.offsetTop-3;else if(i.offsetTop+i.offsetHeight>this.hints.scrollTop+this.hints.clientHeight)this.hints.scrollTop=i.offsetTop+i.offsetHeight-this.hints.clientHeight+3;e.signal(this.data,"select",this.data.list[this.selectedHint],i)},screenAmount:function(){return Math.floor(this.hints.clientHeight/this.hints.firstChild.offsetHeight)||1}};e.registerHelper("hint","auto",function(t,n){var r=t.getHelpers(t.getCursor(),"hint"),i;if(r.length){for(var s=0;s<r.length;s++){var o=r[s](t,n);if(o&&o.list.length)return o}}else if(i=t.getHelper(t.getCursor(),"hintWords")){if(i)return e.hint.fromList(t,{words:i})}else if(e.hint.anyword){return e.hint.anyword(t,n)}});e.registerHelper("hint","fromList",function(t,n){var r=t.getCursor(),i=t.getTokenAt(r);var s=[];for(var o=0;o<n.words.length;o++){var u=n.words[o];if(u.slice(0,i.string.length)==i.string)s.push(u)}if(s.length)return{list:s,from:e.Pos(r.line,i.start),to:e.Pos(r.line,i.end)}});e.commands.autocomplete=e.showHint})