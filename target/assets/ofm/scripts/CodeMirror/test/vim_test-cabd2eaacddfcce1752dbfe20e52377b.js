function copyCursor(e){return{ch:e.ch,line:e.line}}function forEach(e,t){for(var n=0;n<e.length;n++){t(e[n])}}function testVim(e,t,n,r){var i={lineNumbers:true,vimMode:true,showCursorWhenSelecting:true,value:code};for(var s in n){if(n.hasOwnProperty(s)){i[s]=n[s]}}return test("vim_"+e,function(){function s(e){return function(t){if(t instanceof Array){arguments=t}for(var n=0;n<arguments.length;n++){CodeMirror.Vim.handleKey(e,arguments[n])}}}function o(e){return function(t){function n(t){if(typeof t=="string"){CodeMirror.commands[t](e)}else{t(e)}return true}if(t instanceof Array){arguments=t}for(var r=0;r<arguments.length;r++){var i=arguments[r];var s=CodeMirror.lookupKey(i,["vim-insert"],n);if(s===true&&e.state.vim.insertMode&&arguments[r]!="Esc"){var o=CodeMirror.Vim.getVimGlobalState_().macroModeState.lastInsertModeChanges;if(o){o.changes.push(new CodeMirror.Vim.InsertModeKey(i))}}}}}function u(e){return function(t){e.openDialog=c.fakeOpenDialog(t);c.doKeys(":")}}function a(e){return function(t,n){var r;if(n==null&&typeof t.line=="number"){r=t}else{r=makeCursor(t,n)}eqPos(r,e.getCursor())}}function f(e){return function(t,n){return n(e)}}function l(e){return function(t){e(t)}}var e=document.getElementById("testground");var n=CodeMirror(e,i);var r=CodeMirror.Vim.maybeInitVimState_(n);var c={doKeys:s(n),doInsertModeKeys:o(n),doEx:u(n),assertCursorAt:a(n),fakeOpenDialog:f,fakeOpenNotification:l,getRegisterController:function(){return CodeMirror.Vim.getRegisterController()}};CodeMirror.Vim.resetVimGlobalState_();var h=false;var p=n.openNotification;try{t(n,r,c);h=true}finally{n.openNotification=p;if(!h||verbose){e.style.visibility="visible"}else{e.removeChild(n.getWrapperElement())}}},r)}function testJumplist(e,t,n,r,i){n=makeCursor(n[0],n[1]);r=makeCursor(r[0],r[1]);testVim(e,function(e,s,o){CodeMirror.Vim.resetVimGlobalState_();if(i)e.openDialog=o.fakeOpenDialog("word");e.setCursor(r);o.doKeys.apply(null,t);o.assertCursorAt(n)},{value:jumplistScene})}function testMotion(e,t,n,r){testVim(e,function(e,i,s){if(!r){r={line:0,ch:0}}e.setCursor(r);s.doKeys(t);s.assertCursorAt(n)})}function makeCursor(e,t){return{line:e,ch:t}}function offsetCursor(e,t,n){return{line:e.line+t,ch:e.ch+n}}function testEdit(e,t,n,r,i){return testVim(e,function(e,s,o){var u=t.search(n);var a=t.substring(0,u).split("\n").length-1;if(a){u=t.substring(0,u).split("\n").pop().length}e.setCursor(a,u);o.doKeys.apply(this,r.split(""));eq(i,e.getValue())},{value:t})}function testSubstitute(e,t){testVim(e+"_pcre",function(e,n,r){e.setCursor(1,0);CodeMirror.Vim.setOption("pcre",true);r.doEx(t.expr);eq(t.expectedValue,e.getValue())},t);var n=t.noPcreExpr?t.noPcreExpr:t.expr;testVim(e+"_nopcre",function(e,r,i){e.setCursor(1,0);CodeMirror.Vim.setOption("pcre",false);i.doEx(n);eq(t.expectedValue,e.getValue())},t)}function testSubstituteConfirm(e,t,n,r,i,s){testVim(e,function(e,n,o){function h(){c=true}var u=e.openDialog;var a=CodeMirror.keyName;var f;var l;var c=true;e.openDialog=function(e,t,n){l=t};o.doKeys(":");e.openDialog=function(e,t,n){f=n.onKeyDown;c=false};l(t);CodeMirror.keyName=function(e){return e.key};i=i.toUpperCase();for(var p=0;p<i.length;p++){is(!c);f({key:i.charAt(p)},"",h)}try{eq(r,e.getValue());o.assertCursorAt(s);is(c)}catch(d){throw d}finally{CodeMirror.keyName=a;e.openDialog=u}},{value:n})}var code=""+" wOrd1 (#%\n"+" word3] \n"+"aopop pop 0 1 2 3 4\n"+" (a) [b] {c} \n"+"int getchar(void) {\n"+"  static char buf[BUFSIZ];\n"+"  static char *bufp = buf;\n"+"  if (n == 0) {  /* buffer is empty */\n"+"    n = read(0, buf, sizeof buf);\n"+"    bufp = buf;\n"+"  }\n"+"\n"+"  return (--n >= 0) ? (unsigned char) *bufp++ : EOF;\n"+" \n"+"}\n";var lines=function(){lineText=code.split("\n");var e=[];for(var t=0;t<lineText.length;t++){e[t]={line:t,length:lineText[t].length,lineText:lineText[t],textStart:/^\s*/.exec(lineText[t])[0].length}}return e}();var endOfDocument=makeCursor(lines.length-1,lines[lines.length-1].length);var wordLine=lines[0];var bigWordLine=lines[1];var charLine=lines[2];var bracesLine=lines[3];var seekBraceLine=lines[4];var word1={start:{line:wordLine.line,ch:1},end:{line:wordLine.line,ch:5}};var word2={start:{line:wordLine.line,ch:word1.end.ch+2},end:{line:wordLine.line,ch:word1.end.ch+4}};var word3={start:{line:bigWordLine.line,ch:1},end:{line:bigWordLine.line,ch:5}};var bigWord1=word1;var bigWord2=word2;var bigWord3={start:{line:bigWordLine.line,ch:1},end:{line:bigWordLine.line,ch:7}};var bigWord4={start:{line:bigWordLine.line,ch:bigWord1.end.ch+3},end:{line:bigWordLine.line,ch:bigWord1.end.ch+7}};var oChars=[{line:charLine.line,ch:1},{line:charLine.line,ch:3},{line:charLine.line,ch:7}];var pChars=[{line:charLine.line,ch:2},{line:charLine.line,ch:4},{line:charLine.line,ch:6},{line:charLine.line,ch:8}];var numChars=[{line:charLine.line,ch:10},{line:charLine.line,ch:12},{line:charLine.line,ch:14},{line:charLine.line,ch:16},{line:charLine.line,ch:18}];var parens1={start:{line:bracesLine.line,ch:1},end:{line:bracesLine.line,ch:3}};var squares1={start:{line:bracesLine.line,ch:5},end:{line:bracesLine.line,ch:7}};var curlys1={start:{line:bracesLine.line,ch:9},end:{line:bracesLine.line,ch:11}};var seekOutside={start:{line:seekBraceLine.line,ch:1},end:{line:seekBraceLine.line,ch:16}};var seekInside={start:{line:seekBraceLine.line,ch:14},end:{line:seekBraceLine.line,ch:11}};testVim("qq@q",function(e,t,n){e.setCursor(0,0);n.doKeys("q","q","l","l","q");n.assertCursorAt(0,2);n.doKeys("@","q");n.assertCursorAt(0,4)},{value:"            "});testVim("@@",function(e,t,n){e.setCursor(0,0);n.doKeys("q","q","l","l","q");n.assertCursorAt(0,2);n.doKeys("@","q");n.assertCursorAt(0,4);n.doKeys("@","@");n.assertCursorAt(0,6)},{value:"            "});var jumplistScene=""+"word\n"+"(word)\n"+"{word\n"+"word.\n"+"\n"+"word search\n"+"}word\n"+"word\n"+"word\n";testJumplist("jumplist_H",["H","<C-o>"],[5,2],[5,2]);testJumplist("jumplist_M",["M","<C-o>"],[2,2],[2,2]);testJumplist("jumplist_L",["L","<C-o>"],[2,2],[2,2]);testJumplist("jumplist_[[",["[","[","<C-o>"],[5,2],[5,2]);testJumplist("jumplist_]]",["]","]","<C-o>"],[2,2],[2,2]);testJumplist("jumplist_G",["G","<C-o>"],[5,2],[5,2]);testJumplist("jumplist_gg",["g","g","<C-o>"],[5,2],[5,2]);testJumplist("jumplist_%",["%","<C-o>"],[1,5],[1,5]);testJumplist("jumplist_{",["{","<C-o>"],[1,5],[1,5]);testJumplist("jumplist_}",["}","<C-o>"],[1,5],[1,5]);testJumplist("jumplist_'",["m","a","h","'","a","h","<C-i>"],[1,0],[1,5]);testJumplist("jumplist_`",["m","a","h","`","a","h","<C-i>"],[1,5],[1,5]);testJumplist("jumplist_*_cachedCursor",["*","<C-o>"],[1,3],[1,3]);testJumplist("jumplist_#_cachedCursor",["#","<C-o>"],[1,3],[1,3]);testJumplist("jumplist_n",["#","n","<C-o>"],[1,1],[2,3]);testJumplist("jumplist_N",["#","N","<C-o>"],[1,1],[2,3]);testJumplist("jumplist_repeat_<c-o>",["*","*","*","3","<C-o>"],[2,3],[2,3]);testJumplist("jumplist_repeat_<c-i>",["*","*","*","3","<C-o>","2","<C-i>"],[5,0],[2,3]);testJumplist("jumplist_repeated_motion",["3","*","<C-o>"],[2,3],[2,3]);testJumplist("jumplist_/",["/","<C-o>"],[2,3],[2,3],"dialog");testJumplist("jumplist_?",["?","<C-o>"],[2,3],[2,3],"dialog");testJumplist("jumplist_skip_delted_mark<c-o>",["*","n","n","k","d","k","<C-o>","<C-o>","<C-o>"],[0,2],[0,2]);testJumplist("jumplist_skip_delted_mark<c-i>",["*","n","n","k","d","k","<C-o>","<C-i>","<C-i>"],[1,0],[0,2]);testMotion("|","|",makeCursor(0,0),makeCursor(0,4));testMotion("|_repeat",["3","|"],makeCursor(0,2),makeCursor(0,4));testMotion("h","h",makeCursor(0,0),word1.start);testMotion("h_repeat",["3","h"],offsetCursor(word1.end,0,-3),word1.end);testMotion("l","l",makeCursor(0,1));testMotion("l_repeat",["2","l"],makeCursor(0,2));testMotion("j","j",offsetCursor(word1.end,1,0),word1.end);testMotion("j_repeat",["2","j"],offsetCursor(word1.end,2,0),word1.end);testMotion("j_repeat_clip",["1000","j"],endOfDocument);testMotion("k","k",offsetCursor(word3.end,-1,0),word3.end);testMotion("k_repeat",["2","k"],makeCursor(0,4),makeCursor(2,4));testMotion("k_repeat_clip",["1000","k"],makeCursor(0,4),makeCursor(2,4));testMotion("w","w",word1.start);testMotion("w_multiple_newlines_no_space","w",makeCursor(12,2),makeCursor(11,2));testMotion("w_multiple_newlines_with_space","w",makeCursor(14,0),makeCursor(12,51));testMotion("w_repeat",["2","w"],word2.start);testMotion("w_wrap",["w"],word3.start,word2.start);testMotion("w_endOfDocument","w",endOfDocument,endOfDocument);testMotion("w_start_to_end",["1000","w"],endOfDocument,makeCursor(0,0));testMotion("W","W",bigWord1.start);testMotion("W_repeat",["2","W"],bigWord3.start,bigWord1.start);testMotion("e","e",word1.end);testMotion("e_repeat",["2","e"],word2.end);testMotion("e_wrap","e",word3.end,word2.end);testMotion("e_endOfDocument","e",endOfDocument,endOfDocument);testMotion("e_start_to_end",["1000","e"],endOfDocument,makeCursor(0,0));testMotion("b","b",word3.start,word3.end);testMotion("b_repeat",["2","b"],word2.start,word3.end);testMotion("b_wrap","b",word2.start,word3.start);testMotion("b_startOfDocument","b",makeCursor(0,0),makeCursor(0,0));testMotion("b_end_to_start",["1000","b"],makeCursor(0,0),endOfDocument);testMotion("ge",["g","e"],word2.end,word3.end);testMotion("ge_repeat",["2","g","e"],word1.end,word3.start);testMotion("ge_wrap",["g","e"],word2.end,word3.start);testMotion("ge_startOfDocument",["g","e"],makeCursor(0,0),makeCursor(0,0));testMotion("ge_end_to_start",["1000","g","e"],makeCursor(0,0),endOfDocument);testMotion("gg",["g","g"],makeCursor(lines[0].line,lines[0].textStart),makeCursor(3,1));testMotion("gg_repeat",["3","g","g"],makeCursor(lines[2].line,lines[2].textStart));testMotion("G","G",makeCursor(lines[lines.length-1].line,lines[lines.length-1].textStart),makeCursor(3,1));testMotion("G_repeat",["3","G"],makeCursor(lines[2].line,lines[2].textStart));testMotion("0","0",makeCursor(0,0),makeCursor(0,8));testMotion("^","^",makeCursor(0,lines[0].textStart),makeCursor(0,8));testMotion("+","+",makeCursor(1,lines[1].textStart),makeCursor(0,8));testMotion("-","-",makeCursor(0,lines[0].textStart),makeCursor(1,4));testMotion("_",["6","_"],makeCursor(5,lines[5].textStart),makeCursor(0,8));testMotion("$","$",makeCursor(0,lines[0].length-1),makeCursor(0,1));testMotion("$_repeat",["2","$"],makeCursor(1,lines[1].length-1),makeCursor(0,3));testMotion("f",["f","p"],pChars[0],makeCursor(charLine.line,0));testMotion("f_repeat",["2","f","p"],pChars[2],pChars[0]);testMotion("f_num",["f","2"],numChars[2],makeCursor(charLine.line,0));testMotion("t",["t","p"],offsetCursor(pChars[0],0,-1),makeCursor(charLine.line,0));testMotion("t_repeat",["2","t","p"],offsetCursor(pChars[2],0,-1),pChars[0]);testMotion("F",["F","p"],pChars[0],pChars[1]);testMotion("F_repeat",["2","F","p"],pChars[0],pChars[2]);testMotion("T",["T","p"],offsetCursor(pChars[0],0,1),pChars[1]);testMotion("T_repeat",["2","T","p"],offsetCursor(pChars[0],0,1),pChars[2]);testMotion("%_parens",["%"],parens1.end,parens1.start);testMotion("%_squares",["%"],squares1.end,squares1.start);testMotion("%_braces",["%"],curlys1.end,curlys1.start);testMotion("%_seek_outside",["%"],seekOutside.end,seekOutside.start);testMotion("%_seek_inside",["%"],seekInside.end,seekInside.start);testVim("%_seek_skip",function(e,t,n){e.setCursor(0,0);n.doKeys(["%"]);n.assertCursorAt(0,9)},{value:'01234"("()'});testVim("%_skip_string",function(e,t,n){e.setCursor(0,0);n.doKeys(["%"]);n.assertCursorAt(0,4);e.setCursor(0,2);n.doKeys(["%"]);n.assertCursorAt(0,0)},{value:'(")")'});")";testVim("%_skip_comment",function(e,t,n){e.setCursor(0,0);n.doKeys(["%"]);n.assertCursorAt(0,6);e.setCursor(0,3);n.doKeys(["%"]);n.assertCursorAt(0,0)},{value:"(/*)*/)"});testVim("Changing lines after Eol operation",function(e,t,n){e.setCursor(0,0);n.doKeys(["$"]);n.doKeys(["j"]);n.assertCursorAt({line:1,ch:lines[1].length-1});n.doKeys(["j"]);n.assertCursorAt({line:2,ch:lines[2].length-1});n.doKeys(["h"]);n.doKeys(["j"]);n.assertCursorAt({line:3,ch:lines[3].length-1});n.doKeys(["j"]);n.doKeys(["j"]);n.assertCursorAt({line:5,ch:lines[2].length-2})});testVim("gj_gk_clipping",function(e,t,n){e.setCursor(0,1);n.doKeys("g","j","g","j");n.assertCursorAt(2,1);n.doKeys("g","k","g","k");n.assertCursorAt(0,1)},{value:"line 1\n\nline 2"});testVim("j_k_and_gj_gk",function(e,t,n){e.setSize(120);e.setCursor(0,0);n.doKeys("$");n.doKeys("g","k");var r=e.getCursor();eq(r.line,0);is(r.ch<176,"gk didn't move cursor back (1)");n.doKeys("g","j");n.assertCursorAt(0,176);n.doKeys("j");n.doKeys("3","g","k");r=e.getCursor();eq(r.line,1);is(r.ch<176,"gk didn't move cursor back (2)");n.doKeys("g","j","2","g","j");n.doKeys("k");n.assertCursorAt(0,176)},{lineWrapping:true,value:"This line is intentially long to test movement of gj and gk over wrapped lines. I will start on the end of this line, then make a step up and back to set the origin for j and k.\nThis line is supposed to be even longer than the previous. I will jump here and make another wiggle with gj and gk, before I jump back to the line above. Both wiggles should not change my cursor's target character but both j/k and gj/gk change each other's reference position."});testVim("gj_gk",function(e,t,n){if(phantom)return;e.setSize(120);e.setCursor(0,4);n.doKeys("g","j");n.doKeys("10","g","k");n.assertCursorAt(0,4);n.doKeys("g","j");var r=e.getCursor();var i={line:0,ch:(r.ch-4)*2+4};n.doKeys("g","j");n.assertCursorAt(i);e.setCursor(0,0);n.doKeys("h");n.doKeys("100","g","j");var s=e.getCursor();is(s!=0,"gj should not be on wrapped line 0");var o=e.charCoords(makeCursor(0,0));var u=e.charCoords(s);is(o.left==u.left,"gj should end up on column 0")},{lineNumbers:false,lineWrapping:true,value:"Thislineisintentiallylongtotestmovementofgjandgkoverwrappedlines."});testVim("}",function(e,t,n){e.setCursor(0,0);n.doKeys("}");n.assertCursorAt(1,0);e.setCursor(0,0);n.doKeys("2","}");n.assertCursorAt(4,0);e.setCursor(0,0);n.doKeys("6","}");n.assertCursorAt(5,0)},{value:"a\n\nb\nc\n\nd"});testVim("{",function(e,t,n){e.setCursor(5,0);n.doKeys("{");n.assertCursorAt(4,0);e.setCursor(5,0);n.doKeys("2","{");n.assertCursorAt(1,0);e.setCursor(5,0);n.doKeys("6","{");n.assertCursorAt(0,0)},{value:"a\n\nb\nc\n\nd"});testVim("dl",function(e,t,n){var r=makeCursor(0,0);e.setCursor(r);n.doKeys("d","l");eq("word1 ",e.getValue());var i=n.getRegisterController().getRegister();eq(" ",i.toString());is(!i.linewise);eqPos(r,e.getCursor())},{value:" word1 "});testVim("dl_eol",function(e,t,n){e.setCursor(0,6);n.doKeys("d","l");eq(" word1",e.getValue());var r=n.getRegisterController().getRegister();eq(" ",r.toString());is(!r.linewise);n.assertCursorAt(0,5)},{value:" word1 "});testVim("dl_repeat",function(e,t,n){var r=makeCursor(0,0);e.setCursor(r);n.doKeys("2","d","l");eq("ord1 ",e.getValue());var i=n.getRegisterController().getRegister();eq(" w",i.toString());is(!i.linewise);eqPos(r,e.getCursor())},{value:" word1 "});testVim("dh",function(e,t,n){var r=makeCursor(0,3);e.setCursor(r);n.doKeys("d","h");eq(" wrd1 ",e.getValue());var i=n.getRegisterController().getRegister();eq("o",i.toString());is(!i.linewise);eqPos(offsetCursor(r,0,-1),e.getCursor())},{value:" word1 "});testVim("dj",function(e,t,n){var r=makeCursor(0,3);e.setCursor(r);n.doKeys("d","j");eq(" word3",e.getValue());var i=n.getRegisterController().getRegister();eq(" word1\nword2\n",i.toString());is(i.linewise);n.assertCursorAt(0,1)},{value:" word1\nword2\n word3"});testVim("dj_end_of_document",function(e,t,n){var r=makeCursor(0,3);e.setCursor(r);n.doKeys("d","j");eq(" word1 ",e.getValue());var i=n.getRegisterController().getRegister();eq("",i.toString());is(!i.linewise);n.assertCursorAt(0,3)},{value:" word1 "});testVim("dk",function(e,t,n){var r=makeCursor(1,3);e.setCursor(r);n.doKeys("d","k");eq(" word3",e.getValue());var i=n.getRegisterController().getRegister();eq(" word1\nword2\n",i.toString());is(i.linewise);n.assertCursorAt(0,1)},{value:" word1\nword2\n word3"});testVim("dk_start_of_document",function(e,t,n){var r=makeCursor(0,3);e.setCursor(r);n.doKeys("d","k");eq(" word1 ",e.getValue());var i=n.getRegisterController().getRegister();eq("",i.toString());is(!i.linewise);n.assertCursorAt(0,3)},{value:" word1 "});testVim("dw_space",function(e,t,n){var r=makeCursor(0,0);e.setCursor(r);n.doKeys("d","w");eq("word1 ",e.getValue());var i=n.getRegisterController().getRegister();eq(" ",i.toString());is(!i.linewise);eqPos(r,e.getCursor())},{value:" word1 "});testVim("dw_word",function(e,t,n){var r=makeCursor(0,1);e.setCursor(r);n.doKeys("d","w");eq(" word2",e.getValue());var i=n.getRegisterController().getRegister();eq("word1 ",i.toString());is(!i.linewise);eqPos(r,e.getCursor())},{value:" word1 word2"});testVim("dw_only_word",function(e,t,n){e.setCursor(0,1);n.doKeys("d","w");eq(" ",e.getValue());var r=n.getRegisterController().getRegister();eq("word1 ",r.toString());is(!r.linewise);n.assertCursorAt(0,0)},{value:" word1 "});testVim("dw_eol",function(e,t,n){e.setCursor(0,1);n.doKeys("d","w");eq(" \nword2",e.getValue());var r=n.getRegisterController().getRegister();eq("word1",r.toString());is(!r.linewise);n.assertCursorAt(0,0)},{value:" word1\nword2"});testVim("dw_eol_with_multiple_newlines",function(e,t,n){e.setCursor(0,1);n.doKeys("d","w");eq(" \n\nword2",e.getValue());var r=n.getRegisterController().getRegister();eq("word1",r.toString());is(!r.linewise);n.assertCursorAt(0,0)},{value:" word1\n\nword2"});testVim("dw_empty_line_followed_by_whitespace",function(e,t,n){e.setCursor(0,0);n.doKeys("d","w");eq("  \nword",e.getValue())},{value:"\n  \nword"});testVim("dw_empty_line_followed_by_word",function(e,t,n){e.setCursor(0,0);n.doKeys("d","w");eq("word",e.getValue())},{value:"\nword"});testVim("dw_empty_line_followed_by_empty_line",function(e,t,n){e.setCursor(0,0);n.doKeys("d","w");eq("\n",e.getValue())},{value:"\n\n"});testVim("dw_whitespace_followed_by_whitespace",function(e,t,n){e.setCursor(0,0);n.doKeys("d","w");eq("\n   \n",e.getValue())},{value:"  \n   \n"});testVim("dw_whitespace_followed_by_empty_line",function(e,t,n){e.setCursor(0,0);n.doKeys("d","w");eq("\n\n",e.getValue())},{value:"  \n\n"});testVim("dw_word_whitespace_word",function(e,t,n){e.setCursor(0,0);n.doKeys("d","w");eq("\n   \nword2",e.getValue())},{value:"word1\n   \nword2"});testVim("dw_end_of_document",function(e,t,n){e.setCursor(1,2);n.doKeys("d","w");eq("\nab",e.getValue())},{value:"\nabc"});testVim("dw_repeat",function(e,t,n){e.setCursor(0,1);n.doKeys("d","2","w");eq(" ",e.getValue());var r=n.getRegisterController().getRegister();eq("word1\nword2",r.toString());is(!r.linewise);n.assertCursorAt(0,0)},{value:" word1\nword2"});testVim("de_word_start_and_empty_lines",function(e,t,n){e.setCursor(0,0);n.doKeys("d","e");eq("\n\n",e.getValue())},{value:"word\n\n"});testVim("de_word_end_and_empty_lines",function(e,t,n){e.setCursor(0,3);n.doKeys("d","e");eq("wor",e.getValue())},{value:"word\n\n\n"});testVim("de_whitespace_and_empty_lines",function(e,t,n){e.setCursor(0,0);n.doKeys("d","e");eq("",e.getValue())},{value:"   \n\n\n"});testVim("de_end_of_document",function(e,t,n){e.setCursor(1,2);n.doKeys("d","e");eq("\nab",e.getValue())},{value:"\nabc"});testVim("db_empty_lines",function(e,t,n){e.setCursor(2,0);n.doKeys("d","b");eq("\n\n",e.getValue())},{value:"\n\n\n"});testVim("db_word_start_and_empty_lines",function(e,t,n){e.setCursor(2,0);n.doKeys("d","b");eq("\nword",e.getValue())},{value:"\n\nword"});testVim("db_word_end_and_empty_lines",function(e,t,n){e.setCursor(2,3);n.doKeys("d","b");eq("\n\nd",e.getValue())},{value:"\n\nword"});testVim("db_whitespace_and_empty_lines",function(e,t,n){e.setCursor(2,0);n.doKeys("d","b");eq("",e.getValue())},{value:"\n   \n"});testVim("db_start_of_document",function(e,t,n){e.setCursor(0,0);n.doKeys("d","b");eq("abc\n",e.getValue())},{value:"abc\n"});testVim("dge_empty_lines",function(e,t,n){e.setCursor(1,0);n.doKeys("d","g","e");eq("\n",e.getValue())},{value:"\n\n"});testVim("dge_word_and_empty_lines",function(e,t,n){e.setCursor(1,0);n.doKeys("d","g","e");eq("wor\n",e.getValue())},{value:"word\n\n"});testVim("dge_whitespace_and_empty_lines",function(e,t,n){e.setCursor(2,0);n.doKeys("d","g","e");eq("",e.getValue())},{value:"\n  \n"});testVim("dge_start_of_document",function(e,t,n){e.setCursor(0,0);n.doKeys("d","g","e");eq("bc\n",e.getValue())},{value:"abc\n"});testVim("d_inclusive",function(e,t,n){var r=makeCursor(0,1);e.setCursor(r);n.doKeys("d","e");eq("  ",e.getValue());var i=n.getRegisterController().getRegister();eq("word1",i.toString());is(!i.linewise);eqPos(r,e.getCursor())},{value:" word1 "});testVim("d_reverse",function(e,t,n){e.setCursor(1,0);n.doKeys("d","b");eq(" word2 ",e.getValue());var r=n.getRegisterController().getRegister();eq("word1\n",r.toString());is(!r.linewise);n.assertCursorAt(0,1)},{value:" word1\nword2 "});testVim("dd",function(e,t,n){e.setCursor(0,3);var r=e.getRange({line:0,ch:0},{line:1,ch:0});var i=e.lineCount()-1;n.doKeys("d","d");eq(i,e.lineCount());var s=n.getRegisterController().getRegister();eq(r,s.toString());is(s.linewise);n.assertCursorAt(0,lines[1].textStart)});testVim("dd_prefix_repeat",function(e,t,n){e.setCursor(0,3);var r=e.getRange({line:0,ch:0},{line:2,ch:0});var i=e.lineCount()-2;n.doKeys("2","d","d");eq(i,e.lineCount());var s=n.getRegisterController().getRegister();eq(r,s.toString());is(s.linewise);n.assertCursorAt(0,lines[2].textStart)});testVim("dd_motion_repeat",function(e,t,n){e.setCursor(0,3);var r=e.getRange({line:0,ch:0},{line:2,ch:0});var i=e.lineCount()-2;n.doKeys("d","2","d");eq(i,e.lineCount());var s=n.getRegisterController().getRegister();eq(r,s.toString());is(s.linewise);n.assertCursorAt(0,lines[2].textStart)});testVim("dd_multiply_repeat",function(e,t,n){e.setCursor(0,3);var r=e.getRange({line:0,ch:0},{line:6,ch:0});var i=e.lineCount()-6;n.doKeys("2","d","3","d");eq(i,e.lineCount());var s=n.getRegisterController().getRegister();eq(r,s.toString());is(s.linewise);n.assertCursorAt(0,lines[6].textStart)});testVim("dd_lastline",function(e,t,n){e.setCursor(e.lineCount(),0);var r=e.lineCount()-1;n.doKeys("d","d");eq(r,e.lineCount());n.assertCursorAt(e.lineCount()-1,0)});testVim("yw_repeat",function(e,t,n){var r=makeCursor(0,1);e.setCursor(r);n.doKeys("y","2","w");eq(" word1\nword2",e.getValue());var i=n.getRegisterController().getRegister();eq("word1\nword2",i.toString());is(!i.linewise);eqPos(r,e.getCursor())},{value:" word1\nword2"});testVim("yy_multiply_repeat",function(e,t,n){var r=makeCursor(0,3);e.setCursor(r);var i=e.getRange({line:0,ch:0},{line:6,ch:0});var s=e.lineCount();n.doKeys("2","y","3","y");eq(s,e.lineCount());var o=n.getRegisterController().getRegister();eq(i,o.toString());is(o.linewise);eqPos(r,e.getCursor())});testVim("cw",function(e,t,n){e.setCursor(0,0);n.doKeys("c","2","w");eq(" word3",e.getValue());n.assertCursorAt(0,0)},{value:"word1 word2 word3"});testVim("cw_repeat",function(e,t,n){var r=makeCursor(0,1);e.setCursor(r);n.doKeys("c","2","w");eq(" ",e.getValue());var i=n.getRegisterController().getRegister();eq("word1\nword2",i.toString());is(!i.linewise);eqPos(r,e.getCursor());eq("vim-insert",e.getOption("keyMap"))},{value:" word1\nword2"});testVim("cc_multiply_repeat",function(e,t,n){e.setCursor(0,3);var r=e.getRange({line:0,ch:0},{line:6,ch:0});var i=e.lineCount()-5;n.doKeys("2","c","3","c");eq(i,e.lineCount());var s=n.getRegisterController().getRegister();eq(r,s.toString());is(s.linewise);eq("vim-insert",e.getOption("keyMap"))});testVim("cc_append",function(e,t,n){var r=e.lineCount();e.setCursor(e.lastLine(),0);n.doKeys("c","c");eq(r,e.lineCount())});testVim("g~w_repeat",function(e,t,n){var r=makeCursor(0,1);e.setCursor(r);n.doKeys("g","~","2","w");eq(" WORD1\nWORD2",e.getValue());var i=n.getRegisterController().getRegister();eq("",i.toString());is(!i.linewise);eqPos(r,e.getCursor())},{value:" word1\nword2"});testVim("g~g~",function(e,t,n){var r=makeCursor(0,3);e.setCursor(r);var i=e.lineCount();var s=e.getValue().toUpperCase();n.doKeys("2","g","~","3","g","~");eq(s,e.getValue());var o=n.getRegisterController().getRegister();eq("",o.toString());is(!o.linewise);eqPos(r,e.getCursor())},{value:" word1\nword2\nword3\nword4\nword5\nword6"});testVim(">{motion}",function(e,t,n){e.setCursor(1,3);var r=e.lineCount();var i="   word1\n  word2\nword3 ";n.doKeys(">","k");eq(i,e.getValue());var s=n.getRegisterController().getRegister();eq("",s.toString());is(!s.linewise);n.assertCursorAt(0,3)},{value:" word1\nword2\nword3 ",indentUnit:2});testVim(">>",function(e,t,n){e.setCursor(0,3);var r=e.lineCount();var i="   word1\n  word2\nword3 ";n.doKeys("2",">",">");eq(i,e.getValue());var s=n.getRegisterController().getRegister();eq("",s.toString());is(!s.linewise);n.assertCursorAt(0,3)},{value:" word1\nword2\nword3 ",indentUnit:2});testVim("<{motion}",function(e,t,n){e.setCursor(1,3);var r=e.lineCount();var i=" word1\nword2\nword3 ";n.doKeys("<","k");eq(i,e.getValue());var s=n.getRegisterController().getRegister();eq("",s.toString());is(!s.linewise);n.assertCursorAt(0,1)},{value:"   word1\n  word2\nword3 ",indentUnit:2});testVim("<<",function(e,t,n){e.setCursor(0,3);var r=e.lineCount();var i=" word1\nword2\nword3 ";n.doKeys("2","<","<");eq(i,e.getValue());var s=n.getRegisterController().getRegister();eq("",s.toString());is(!s.linewise);n.assertCursorAt(0,1)},{value:"   word1\n  word2\nword3 ",indentUnit:2});testEdit("diw_mid_spc","foo 	bAr	 baz",/A/,"diw","foo 		 baz");testEdit("daw_mid_spc","foo 	bAr	 baz",/A/,"daw","foo 	baz");testEdit("diw_mid_punct","foo 	bAr.	 baz",/A/,"diw","foo 	.	 baz");testEdit("daw_mid_punct","foo 	bAr.	 baz",/A/,"daw","foo.	 baz");testEdit("diw_mid_punct2","foo 	,bAr.	 baz",/A/,"diw","foo 	,.	 baz");testEdit("daw_mid_punct2","foo 	,bAr.	 baz",/A/,"daw","foo 	,.	 baz");testEdit("diw_start_spc","bAr 	baz",/A/,"diw"," 	baz");testEdit("daw_start_spc","bAr 	baz",/A/,"daw","baz");testEdit("diw_start_punct","bAr. 	baz",/A/,"diw",". 	baz");testEdit("daw_start_punct","bAr. 	baz",/A/,"daw",". 	baz");testEdit("diw_end_spc","foo 	bAr",/A/,"diw","foo 	");testEdit("daw_end_spc","foo 	bAr",/A/,"daw","foo");testEdit("diw_end_punct","foo 	bAr.",/A/,"diw","foo 	.");testEdit("daw_end_punct","foo 	bAr.",/A/,"daw","foo.");testEdit("diW_mid_spc","foo 	bAr	 baz",/A/,"diW","foo 		 baz");testEdit("daW_mid_spc","foo 	bAr	 baz",/A/,"daW","foo 	baz");testEdit("diW_mid_punct","foo 	bAr.	 baz",/A/,"diW","foo 		 baz");testEdit("daW_mid_punct","foo 	bAr.	 baz",/A/,"daW","foo 	baz");testEdit("diW_mid_punct2","foo 	,bAr.	 baz",/A/,"diW","foo 		 baz");testEdit("daW_mid_punct2","foo 	,bAr.	 baz",/A/,"daW","foo 	baz");testEdit("diW_start_spc","bAr	 baz",/A/,"diW","	 baz");testEdit("daW_start_spc","bAr	 baz",/A/,"daW","baz");testEdit("diW_start_punct","bAr.	 baz",/A/,"diW","	 baz");testEdit("daW_start_punct","bAr.	 baz",/A/,"daW","baz");testEdit("diW_end_spc","foo 	bAr",/A/,"diW","foo 	");testEdit("daW_end_spc","foo 	bAr",/A/,"daW","foo");testEdit("diW_end_punct","foo 	bAr.",/A/,"diW","foo 	");testEdit("daW_end_punct","foo 	bAr.",/A/,"daW","foo");testEdit("di(_open_spc","foo (bAr) baz",/\(/,"di(","foo () baz");testEdit("di)_open_spc","foo (bAr) baz",/\(/,"di)","foo () baz");testEdit("dib_open_spc","foo (bAr) baz",/\(/,"dib","foo () baz");testEdit("da(_open_spc","foo (bAr) baz",/\(/,"da(","foo  baz");testEdit("da)_open_spc","foo (bAr) baz",/\(/,"da)","foo  baz");testEdit("di(_middle_spc","foo (bAr) baz",/A/,"di(","foo () baz");testEdit("di)_middle_spc","foo (bAr) baz",/A/,"di)","foo () baz");testEdit("da(_middle_spc","foo (bAr) baz",/A/,"da(","foo  baz");testEdit("da)_middle_spc","foo (bAr) baz",/A/,"da)","foo  baz");testEdit("di(_close_spc","foo (bAr) baz",/\)/,"di(","foo () baz");testEdit("di)_close_spc","foo (bAr) baz",/\)/,"di)","foo () baz");testEdit("da(_close_spc","foo (bAr) baz",/\)/,"da(","foo  baz");testEdit("da)_close_spc","foo (bAr) baz",/\)/,"da)","foo  baz");testEdit("dab_on_(_should_delete_around_()block","o( in(abc) )",/\(a/,"dab","o( in )");testEdit("daB_on_{_should_delete_around_{}block","o{ in{abc} }",/{a/,"daB","o{ in }");testEdit("diB_on_{_should_delete_inner_{}block","o{ in{abc} }",/{a/,"diB","o{ in{} }");testEdit("da{_on_{_should_delete_inner_block","o{ in{abc} }",/{a/,"da{","o{ in }");testEdit("di[_on_(_should_not_delete","foo (bAr) baz",/\(/,"di[","foo (bAr) baz");testEdit("di[_on_)_should_not_delete","foo (bAr) baz",/\)/,"di[","foo (bAr) baz");testEdit("da[_on_(_should_not_delete","foo (bAr) baz",/\(/,"da[","foo (bAr) baz");testEdit("da[_on_)_should_not_delete","foo (bAr) baz",/\)/,"da[","foo (bAr) baz");testMotion("di(_outside_should_stay",["d","i","("],{line:0,ch:0},{line:0,ch:0});testEdit("di{_middle_spc","a{\n	bar\n}b",/r/,"di{","a{}b");testEdit("di}_middle_spc","a{\n	bar\n}b",/r/,"di}","a{}b");testEdit("da{_middle_spc","a{\n	bar\n}b",/r/,"da{","ab");testEdit("da}_middle_spc","a{\n	bar\n}b",/r/,"da}","ab");testEdit("daB_middle_spc","a{\n	bar\n}b",/r/,"daB","ab");testEdit("di{_middle_spc","a{\n	bar\n	}b",/r/,"di{","a{}b");testEdit("di}_middle_spc","a{\n	bar\n	}b",/r/,"di}","a{}b");testEdit("da{_middle_spc","a{\n	bar\n	}b",/r/,"da{","ab");testEdit("da}_middle_spc","a{\n	bar\n	}b",/r/,"da}","ab");testEdit("di[_middle_spc","a	[\n	bar\n]b",/r/,"di[","a	[]b");testEdit("di]_middle_spc","a	[\n	bar\n]b",/r/,"di]","a	[]b");testEdit("da[_middle_spc","a	[\n	bar\n]b",/r/,"da[","a	b");testEdit("da]_middle_spc","a	[\n	bar\n]b",/r/,"da]","a	b");testVim("D",function(e,t,n){e.setCursor(0,3);n.doKeys("D");eq(" wo\nword2\n word3",e.getValue());var r=n.getRegisterController().getRegister();eq("rd1",r.toString());is(!r.linewise);n.assertCursorAt(0,2)},{value:" word1\nword2\n word3"});testVim("C",function(e,t,n){var r=makeCursor(0,3);e.setCursor(r);n.doKeys("C");eq(" wo\nword2\n word3",e.getValue());var i=n.getRegisterController().getRegister();eq("rd1",i.toString());is(!i.linewise);eqPos(r,e.getCursor());eq("vim-insert",e.getOption("keyMap"))},{value:" word1\nword2\n word3"});testVim("Y",function(e,t,n){var r=makeCursor(0,3);e.setCursor(r);n.doKeys("Y");eq(" word1\nword2\n word3",e.getValue());var i=n.getRegisterController().getRegister();eq("rd1",i.toString());is(!i.linewise);n.assertCursorAt(0,3)},{value:" word1\nword2\n word3"});testVim("~",function(e,t,n){n.doKeys("3","~");eq("ABCdefg",e.getValue());n.assertCursorAt(0,3)},{value:"abcdefg"});testVim("ctrl-a",function(e,t,n){e.setCursor(0,0);n.doKeys("<C-a>");eq("-9",e.getValue());n.assertCursorAt(0,1);n.doKeys("2","<C-a>");eq("-7",e.getValue())},{value:"-10"});testVim("ctrl-x",function(e,t,n){e.setCursor(0,0);n.doKeys("<C-x>");eq("-1",e.getValue());n.assertCursorAt(0,1);n.doKeys("2","<C-x>");eq("-3",e.getValue())},{value:"0"});testVim("<C-x>/<C-a> search forward",function(e,t,n){forEach(["<C-x>","<C-a>"],function(t){e.setCursor(0,0);n.doKeys(t);n.assertCursorAt(0,5);n.doKeys("l");n.doKeys(t);n.assertCursorAt(0,10);e.setCursor(0,11);n.doKeys(t);n.assertCursorAt(0,11)})},{value:"__jmp1 jmp2 jmp"});testVim("a",function(e,t,n){e.setCursor(0,1);n.doKeys("a");n.assertCursorAt(0,2);eq("vim-insert",e.getOption("keyMap"))});testVim("a_eol",function(e,t,n){e.setCursor(0,lines[0].length-1);n.doKeys("a");n.assertCursorAt(0,lines[0].length);eq("vim-insert",e.getOption("keyMap"))});testVim("i",function(e,t,n){e.setCursor(0,1);n.doKeys("i");n.assertCursorAt(0,1);eq("vim-insert",e.getOption("keyMap"))});testVim("i_repeat",function(e,t,n){n.doKeys("3","i");e.replaceRange("test",e.getCursor());n.doInsertModeKeys("Esc");eq("testtesttest",e.getValue());n.assertCursorAt(0,11)},{value:""});testVim("i_repeat_delete",function(e,t,n){e.setCursor(0,4);n.doKeys("2","i");e.replaceRange("z",e.getCursor());n.doInsertModeKeys("Backspace","Backspace","Esc");eq("abe",e.getValue());n.assertCursorAt(0,1)},{value:"abcde"});testVim("A",function(e,t,n){n.doKeys("A");n.assertCursorAt(0,lines[0].length);eq("vim-insert",e.getOption("keyMap"))});testVim("I",function(e,t,n){e.setCursor(0,4);n.doKeys("I");n.assertCursorAt(0,lines[0].textStart);eq("vim-insert",e.getOption("keyMap"))});testVim("I_repeat",function(e,t,n){e.setCursor(0,1);n.doKeys("3","I");e.replaceRange("test",e.getCursor());n.doInsertModeKeys("Esc");eq("testtesttestblah",e.getValue());n.assertCursorAt(0,11)},{value:"blah"});testVim("o",function(e,t,n){e.setCursor(0,4);n.doKeys("o");eq("word1\n\nword2",e.getValue());n.assertCursorAt(1,0);eq("vim-insert",e.getOption("keyMap"))},{value:"word1\nword2"});testVim("o_repeat",function(e,t,n){e.setCursor(0,0);n.doKeys("3","o");e.replaceRange("test",e.getCursor());n.doInsertModeKeys("Esc");eq("\ntest\ntest\ntest",e.getValue());n.assertCursorAt(3,3)},{value:""});testVim("O",function(e,t,n){e.setCursor(0,4);n.doKeys("O");eq("\nword1\nword2",e.getValue());n.assertCursorAt(0,0);eq("vim-insert",e.getOption("keyMap"))},{value:"word1\nword2"});testVim("J",function(e,t,n){e.setCursor(0,4);n.doKeys("J");var r="word1  word2\nword3\n word4";eq(r,e.getValue());n.assertCursorAt(0,r.indexOf("word2")-1)},{value:"word1 \n    word2\nword3\n word4"});testVim("J_repeat",function(e,t,n){e.setCursor(0,4);n.doKeys("3","J");var r="word1  word2 word3\n word4";eq(r,e.getValue());n.assertCursorAt(0,r.indexOf("word3")-1)},{value:"word1 \n    word2\nword3\n word4"});testVim("p",function(e,t,n){e.setCursor(0,1);n.getRegisterController().pushText('"',"yank","abc\ndef",false);n.doKeys("p");eq("__abc\ndef_",e.getValue());n.assertCursorAt(1,2)},{value:"___"});testVim("p_register",function(e,t,n){e.setCursor(0,1);n.getRegisterController().getRegister("a").setText("abc\ndef",false);n.doKeys('"',"a","p");eq("__abc\ndef_",e.getValue());n.assertCursorAt(1,2)},{value:"___"});testVim("p_wrong_register",function(e,t,n){e.setCursor(0,1);n.getRegisterController().getRegister("a").setText("abc\ndef",false);n.doKeys("p");eq("___",e.getValue());n.assertCursorAt(0,1)},{value:"___"});testVim("p_line",function(e,t,n){e.setCursor(0,1);n.getRegisterController().pushText('"',"yank","  a\nd\n",true);n.doKeys("2","p");eq("___\n  a\nd\n  a\nd",e.getValue());n.assertCursorAt(1,2)},{value:"___"});testVim("p_lastline",function(e,t,n){e.setCursor(0,1);n.getRegisterController().pushText('"',"yank","  a\nd",true);n.doKeys("2","p");eq("___\n  a\nd\n  a\nd",e.getValue());n.assertCursorAt(1,2)},{value:"___"});testVim("]p_first_indent_is_smaller",function(e,t,n){n.getRegisterController().pushText('"',"yank","  abc\n    def\n",true);n.doKeys("]","p");eq("  ___\n  abc\n    def",e.getValue())},{value:"  ___"});testVim("]p_first_indent_is_larger",function(e,t,n){n.getRegisterController().pushText('"',"yank","    abc\n  def\n",true);n.doKeys("]","p");eq("  ___\n  abc\ndef",e.getValue())},{value:"  ___"});testVim("]p_with_tab_indents",function(e,t,n){n.getRegisterController().pushText('"',"yank","		abc\n			def\n",true);n.doKeys("]","p");eq("	___\n	abc\n		def",e.getValue())},{value:"	___",indentWithTabs:true});testVim("]p_with_spaces_translated_to_tabs",function(e,t,n){n.getRegisterController().pushText('"',"yank","  abc\n    def\n",true);n.doKeys("]","p");eq("	___\n	abc\n		def",e.getValue())},{value:"	___",indentWithTabs:true,tabSize:2});testVim("[p",function(e,t,n){n.getRegisterController().pushText('"',"yank","  abc\n    def\n",true);n.doKeys("[","p");eq("  abc\n    def\n  ___",e.getValue())},{value:"  ___"});testVim("P",function(e,t,n){e.setCursor(0,1);n.getRegisterController().pushText('"',"yank","abc\ndef",false);n.doKeys("P");eq("_abc\ndef__",e.getValue());n.assertCursorAt(1,3)},{value:"___"});testVim("P_line",function(e,t,n){e.setCursor(0,1);n.getRegisterController().pushText('"',"yank","  a\nd\n",true);n.doKeys("2","P");eq("  a\nd\n  a\nd\n___",e.getValue());n.assertCursorAt(0,2)},{value:"___"});testVim("r",function(e,t,n){e.setCursor(0,1);n.doKeys("3","r","u");eq("wuuuet\nanother",e.getValue(),"3r failed");n.assertCursorAt(0,3);e.setCursor(0,4);n.doKeys("v","j","h","r","<Space>");eq("wuuu  \n    her",e.getValue(),"Replacing selection by space-characters failed")},{value:"wordet\nanother"});testVim("R",function(e,t,n){e.setCursor(0,1);n.doKeys("R");n.assertCursorAt(0,1);eq("vim-replace",e.getOption("keyMap"));is(e.state.overwrite,"Setting overwrite state failed")});testVim("mark",function(e,t,n){e.setCursor(2,2);n.doKeys("m","t");e.setCursor(0,0);n.doKeys("`","t");n.assertCursorAt(2,2);e.setCursor(2,0);e.replaceRange("   h",e.getCursor());e.setCursor(0,0);n.doKeys("'","t");n.assertCursorAt(2,3)});testVim("jumpToMark_next",function(e,t,n){e.setCursor(2,2);n.doKeys("m","t");e.setCursor(0,0);n.doKeys("]","`");n.assertCursorAt(2,2);e.setCursor(0,0);n.doKeys("]","'");n.assertCursorAt(2,0)});testVim("jumpToMark_next_repeat",function(e,t,n){e.setCursor(2,2);n.doKeys("m","a");e.setCursor(3,2);n.doKeys("m","b");e.setCursor(4,2);n.doKeys("m","c");e.setCursor(0,0);n.doKeys("2","]","`");n.assertCursorAt(3,2);e.setCursor(0,0);n.doKeys("2","]","'");n.assertCursorAt(3,1)});testVim("jumpToMark_next_sameline",function(e,t,n){e.setCursor(2,0);n.doKeys("m","a");e.setCursor(2,4);n.doKeys("m","b");e.setCursor(2,2);n.doKeys("]","`");n.assertCursorAt(2,4)});testVim("jumpToMark_next_onlyprev",function(e,t,n){e.setCursor(2,0);n.doKeys("m","a");e.setCursor(4,0);n.doKeys("]","`");n.assertCursorAt(4,0)});testVim("jumpToMark_next_nomark",function(e,t,n){e.setCursor(2,2);n.doKeys("]","`");n.assertCursorAt(2,2);n.doKeys("]","'");n.assertCursorAt(2,0)});testVim("jumpToMark_next_linewise_over",function(e,t,n){e.setCursor(2,2);n.doKeys("m","a");e.setCursor(3,4);n.doKeys("m","b");e.setCursor(2,1);n.doKeys("]","'");n.assertCursorAt(3,1)});testVim("jumpToMark_next_action",function(e,t,n){e.setCursor(2,2);n.doKeys("m","t");e.setCursor(0,0);n.doKeys("d","]","`");n.assertCursorAt(0,0);var r=e.getLine(0);var i="pop pop 0 1 2 3 4";eq(r,i,"Deleting while jumping to the next mark failed.")});testVim("jumpToMark_next_line_action",function(e,t,n){e.setCursor(2,2);n.doKeys("m","t");e.setCursor(0,0);n.doKeys("d","]","'");n.assertCursorAt(0,1);var r=e.getLine(0);var i=" (a) [b] {c} ";eq(r,i,"Deleting while jumping to the next mark line failed.")});testVim("jumpToMark_prev",function(e,t,n){e.setCursor(2,2);n.doKeys("m","t");e.setCursor(4,0);n.doKeys("[","`");n.assertCursorAt(2,2);e.setCursor(4,0);n.doKeys("[","'");n.assertCursorAt(2,0)});testVim("jumpToMark_prev_repeat",function(e,t,n){e.setCursor(2,2);n.doKeys("m","a");e.setCursor(3,2);n.doKeys("m","b");e.setCursor(4,2);n.doKeys("m","c");e.setCursor(5,0);n.doKeys("2","[","`");n.assertCursorAt(3,2);e.setCursor(5,0);n.doKeys("2","[","'");n.assertCursorAt(3,1)});testVim("jumpToMark_prev_sameline",function(e,t,n){e.setCursor(2,0);n.doKeys("m","a");e.setCursor(2,4);n.doKeys("m","b");e.setCursor(2,2);n.doKeys("[","`");n.assertCursorAt(2,0)});testVim("jumpToMark_prev_onlynext",function(e,t,n){e.setCursor(4,4);n.doKeys("m","a");e.setCursor(2,0);n.doKeys("[","`");n.assertCursorAt(2,0)});testVim("jumpToMark_prev_nomark",function(e,t,n){e.setCursor(2,2);n.doKeys("[","`");n.assertCursorAt(2,2);n.doKeys("[","'");n.assertCursorAt(2,0)});testVim("jumpToMark_prev_linewise_over",function(e,t,n){e.setCursor(2,2);n.doKeys("m","a");e.setCursor(3,4);n.doKeys("m","b");e.setCursor(3,6);n.doKeys("[","'");n.assertCursorAt(2,0)});testVim("delmark_single",function(e,t,n){e.setCursor(1,2);n.doKeys("m","t");n.doEx("delmarks t");e.setCursor(0,0);n.doKeys("`","t");n.assertCursorAt(0,0)});testVim("delmark_range",function(e,t,n){e.setCursor(1,2);n.doKeys("m","a");e.setCursor(2,2);n.doKeys("m","b");e.setCursor(3,2);n.doKeys("m","c");e.setCursor(4,2);n.doKeys("m","d");e.setCursor(5,2);n.doKeys("m","e");n.doEx("delmarks b-d");e.setCursor(0,0);n.doKeys("`","a");n.assertCursorAt(1,2);n.doKeys("`","b");n.assertCursorAt(1,2);n.doKeys("`","c");n.assertCursorAt(1,2);n.doKeys("`","d");n.assertCursorAt(1,2);n.doKeys("`","e");n.assertCursorAt(5,2)});testVim("delmark_multi",function(e,t,n){e.setCursor(1,2);n.doKeys("m","a");e.setCursor(2,2);n.doKeys("m","b");e.setCursor(3,2);n.doKeys("m","c");e.setCursor(4,2);n.doKeys("m","d");e.setCursor(5,2);n.doKeys("m","e");n.doEx("delmarks bcd");e.setCursor(0,0);n.doKeys("`","a");n.assertCursorAt(1,2);n.doKeys("`","b");n.assertCursorAt(1,2);n.doKeys("`","c");n.assertCursorAt(1,2);n.doKeys("`","d");n.assertCursorAt(1,2);n.doKeys("`","e");n.assertCursorAt(5,2)});testVim("delmark_multi_space",function(e,t,n){e.setCursor(1,2);n.doKeys("m","a");e.setCursor(2,2);n.doKeys("m","b");e.setCursor(3,2);n.doKeys("m","c");e.setCursor(4,2);n.doKeys("m","d");e.setCursor(5,2);n.doKeys("m","e");n.doEx("delmarks b c d");e.setCursor(0,0);n.doKeys("`","a");n.assertCursorAt(1,2);n.doKeys("`","b");n.assertCursorAt(1,2);n.doKeys("`","c");n.assertCursorAt(1,2);n.doKeys("`","d");n.assertCursorAt(1,2);n.doKeys("`","e");n.assertCursorAt(5,2)});testVim("delmark_all",function(e,t,n){e.setCursor(1,2);n.doKeys("m","a");e.setCursor(2,2);n.doKeys("m","b");e.setCursor(3,2);n.doKeys("m","c");e.setCursor(4,2);n.doKeys("m","d");e.setCursor(5,2);n.doKeys("m","e");n.doEx("delmarks a b-de");e.setCursor(0,0);n.doKeys("`","a");n.assertCursorAt(0,0);n.doKeys("`","b");n.assertCursorAt(0,0);n.doKeys("`","c");n.assertCursorAt(0,0);n.doKeys("`","d");n.assertCursorAt(0,0);n.doKeys("`","e");n.assertCursorAt(0,0)});testVim("visual",function(e,t,n){n.doKeys("l","v","l","l");n.assertCursorAt(0,3);eqPos(makeCursor(0,1),e.getCursor("anchor"));n.doKeys("d");eq("15",e.getValue())},{value:"12345"});testVim("visual_line",function(e,t,n){n.doKeys("l","V","l","j","j","d");eq(" 4\n 5",e.getValue())},{value:" 1\n 2\n 3\n 4\n 5"});testVim("visual_marks",function(e,t,n){n.doKeys("l","v","l","l","j","j","v");e.setCursor(2,1);n.doKeys("'","<");n.assertCursorAt(0,1);n.doKeys("'",">");n.assertCursorAt(2,0)});testVim("visual_join",function(e,t,n){n.doKeys("l","V","l","j","j","J");eq(" 1 2 3\n 4\n 5",e.getValue())},{value:" 1\n 2\n 3\n 4\n 5"});testVim("visual_blank",function(e,t,n){n.doKeys("v","k");eq(t.visualMode,true)},{value:"\n"});testVim("reselect_visual",function(e,t,n){n.doKeys("l","v","l","l","y","g","v");n.assertCursorAt(0,3);eqPos(makeCursor(0,1),e.getCursor("anchor"));n.doKeys("d");eq("15",e.getValue())},{value:"12345"});testVim("reselect_visual_line",function(e,t,n){n.doKeys("l","V","l","j","j","V","g","v","d");eq(" 4\n 5",e.getValue())},{value:" 1\n 2\n 3\n 4\n 5"});testVim("s_normal",function(e,t,n){e.setCursor(0,1);n.doKeys("s");n.doInsertModeKeys("Esc");n.assertCursorAt(0,0);eq("ac",e.getValue())},{value:"abc"});testVim("s_visual",function(e,t,n){e.setCursor(0,1);n.doKeys("v","s");n.doInsertModeKeys("Esc");n.assertCursorAt(0,0);eq("ac",e.getValue())},{value:"abc"});testVim("o_visual",function(e,t,n){e.setCursor(0,0);n.doKeys("v","l","l","l","o");n.assertCursorAt(0,0);n.doKeys("v","v","j","j","j","o");n.assertCursorAt(0,0);n.doKeys("o");n.doKeys("l","l");n.assertCursorAt(3,2);n.doKeys("d");eq("p",e.getValue())},{value:"abcd\nefgh\nijkl\nmnop"});testVim("S_normal",function(e,t,n){e.setCursor(0,1);n.doKeys("j","S");n.doInsertModeKeys("Esc");n.assertCursorAt(1,0);eq("aa\n\ncc",e.getValue())},{value:"aa\nbb\ncc"});testVim("S_visual",function(e,t,n){e.setCursor(0,1);n.doKeys("v","j","S");n.doInsertModeKeys("Esc");n.assertCursorAt(0,0);eq("\ncc",e.getValue())},{value:"aa\nbb\ncc"});testVim("/ and n/N",function(e,t,n){e.openDialog=n.fakeOpenDialog("match");n.doKeys("/");n.assertCursorAt(0,11);n.doKeys("n");n.assertCursorAt(1,6);n.doKeys("N");n.assertCursorAt(0,11);e.setCursor(0,0);n.doKeys("2","/");n.assertCursorAt(1,6)},{value:"match nope match \n nope Match"});testVim("/_case",function(e,t,n){e.openDialog=n.fakeOpenDialog("Match");n.doKeys("/");n.assertCursorAt(1,6)},{value:"match nope match \n nope Match"});testVim("/_2_pcre",function(e,t,n){CodeMirror.Vim.setOption("pcre",true);e.openDialog=n.fakeOpenDialog("(word){2}");n.doKeys("/");n.assertCursorAt(1,9);n.doKeys("n");n.assertCursorAt(2,1)},{value:"word\n another wordword\n wordwordword\n"});testVim("/_2_nopcre",function(e,t,n){CodeMirror.Vim.setOption("pcre",false);e.openDialog=n.fakeOpenDialog("\\(word\\)\\{2}");n.doKeys("/");n.assertCursorAt(1,9);n.doKeys("n");n.assertCursorAt(2,1)},{value:"word\n another wordword\n wordwordword\n"});testVim("/_nongreedy",function(e,t,n){e.openDialog=n.fakeOpenDialog("aa");n.doKeys("/");n.assertCursorAt(0,4);n.doKeys("n");n.assertCursorAt(1,3);n.doKeys("n");n.assertCursorAt(0,0)},{value:"aaa aa \n a aa"});testVim("?_nongreedy",function(e,t,n){e.openDialog=n.fakeOpenDialog("aa");n.doKeys("?");n.assertCursorAt(1,3);n.doKeys("n");n.assertCursorAt(0,4);n.doKeys("n");n.assertCursorAt(0,0)},{value:"aaa aa \n a aa"});testVim("/_greedy",function(e,t,n){e.openDialog=n.fakeOpenDialog("a+");n.doKeys("/");n.assertCursorAt(0,4);n.doKeys("n");n.assertCursorAt(1,1);n.doKeys("n");n.assertCursorAt(1,3);n.doKeys("n");n.assertCursorAt(0,0)},{value:"aaa aa \n a aa"});testVim("?_greedy",function(e,t,n){e.openDialog=n.fakeOpenDialog("a+");n.doKeys("?");n.assertCursorAt(1,3);n.doKeys("n");n.assertCursorAt(1,1);n.doKeys("n");n.assertCursorAt(0,4);n.doKeys("n");n.assertCursorAt(0,0)},{value:"aaa aa \n a aa"});testVim("/_greedy_0_or_more",function(e,t,n){e.openDialog=n.fakeOpenDialog("a*");n.doKeys("/");n.assertCursorAt(0,3);n.doKeys("n");n.assertCursorAt(0,4);n.doKeys("n");n.assertCursorAt(0,5);n.doKeys("n");n.assertCursorAt(1,0);n.doKeys("n");n.assertCursorAt(1,1);n.doKeys("n");n.assertCursorAt(0,0)},{value:"aaa  aa\n aa"});testVim("?_greedy_0_or_more",function(e,t,n){e.openDialog=n.fakeOpenDialog("a*");n.doKeys("?");n.assertCursorAt(1,1);n.doKeys("n");n.assertCursorAt(1,0);n.doKeys("n");n.assertCursorAt(0,5);n.doKeys("n");n.assertCursorAt(0,4);n.doKeys("n");n.assertCursorAt(0,3);n.doKeys("n");n.assertCursorAt(0,0)},{value:"aaa  aa\n aa"});testVim("? and n/N",function(e,t,n){e.openDialog=n.fakeOpenDialog("match");n.doKeys("?");n.assertCursorAt(1,6);n.doKeys("n");n.assertCursorAt(0,11);n.doKeys("N");n.assertCursorAt(1,6);e.setCursor(0,0);n.doKeys("2","?");n.assertCursorAt(0,11)},{value:"match nope match \n nope Match"});testVim("*",function(e,t,n){e.setCursor(0,9);n.doKeys("*");n.assertCursorAt(0,22);e.setCursor(0,9);n.doKeys("2","*");n.assertCursorAt(1,8)},{value:"nomatch match nomatch match \nnomatch Match"});testVim("*_no_word",function(e,t,n){e.setCursor(0,0);n.doKeys("*");n.assertCursorAt(0,0)},{value:" \n match \n"});testVim("*_symbol",function(e,t,n){e.setCursor(0,0);n.doKeys("*");n.assertCursorAt(1,0)},{value:" /}\n/} match \n"});testVim("#",function(e,t,n){e.setCursor(0,9);n.doKeys("#");n.assertCursorAt(1,8);e.setCursor(0,9);n.doKeys("2","#");n.assertCursorAt(0,22)},{value:"nomatch match nomatch match \nnomatch Match"});testVim("*_seek",function(e,t,n){e.setCursor(0,3);n.doKeys("*");n.assertCursorAt(0,22)},{value:"    :=  match nomatch match \nnomatch Match"});testVim("#",function(e,t,n){e.setCursor(0,3);n.doKeys("#");n.assertCursorAt(1,8)},{value:"    :=  match nomatch match \nnomatch Match"});testVim("g*",function(e,t,n){e.setCursor(0,8);n.doKeys("g","*");n.assertCursorAt(0,18);e.setCursor(0,8);n.doKeys("3","g","*");n.assertCursorAt(1,8)},{value:"matches match alsoMatch\nmatchme matching"});testVim("g#",function(e,t,n){e.setCursor(0,8);n.doKeys("g","#");n.assertCursorAt(0,0);e.setCursor(0,8);n.doKeys("3","g","#");n.assertCursorAt(1,0)},{value:"matches match alsoMatch\nmatchme matching"});testVim("macro_insert",function(e,t,n){e.setCursor(0,0);n.doKeys("q","a","0","i");e.replaceRange("foo",e.getCursor());n.doInsertModeKeys("Esc");n.doKeys("q","@","a");eq("foofoo",e.getValue())},{value:""});testVim("macro_space",function(e,t,n){e.setCursor(0,0);n.doKeys("<Space>","<Space>");n.assertCursorAt(0,2);n.doKeys("q","a","<Space>","<Space>","q");n.assertCursorAt(0,4);n.doKeys("@","a");n.assertCursorAt(0,6);n.doKeys("@","a");n.assertCursorAt(0,8)},{value:"one line of text."});testVim("macro_t_search",function(e,t,n){e.setCursor(0,0);n.doKeys("q","a","t","e","q");n.assertCursorAt(0,1);n.doKeys("l","@","a");n.assertCursorAt(0,6);n.doKeys("l",";");n.assertCursorAt(0,12)},{value:"one line of text."});testVim("macro_f_search",function(e,t,n){e.setCursor(0,0);n.doKeys("q","b","f","e","q");n.assertCursorAt(0,2);n.doKeys("@","b");n.assertCursorAt(0,7);n.doKeys(";");n.assertCursorAt(0,13)},{value:"one line of text."});testVim("macro_slash_search",function(e,t,n){e.setCursor(0,0);n.doKeys("q","c");e.openDialog=n.fakeOpenDialog("e");n.doKeys("/","q");n.assertCursorAt(0,2);n.doKeys("@","c");n.assertCursorAt(0,7);n.doKeys("n");n.assertCursorAt(0,13)},{value:"one line of text."});testVim("macro_multislash_search",function(e,t,n){e.setCursor(0,0);n.doKeys("q","d");e.openDialog=n.fakeOpenDialog("e");n.doKeys("/");e.openDialog=n.fakeOpenDialog("t");n.doKeys("/","q");n.assertCursorAt(0,12);n.doKeys("@","d");n.assertCursorAt(0,15)},{value:"one line of text to rule them all."});testVim("macro_parens",function(e,t,n){e.setCursor(0,0);n.doKeys("q","z","i");e.replaceRange("(",e.getCursor());n.doInsertModeKeys("Esc");n.doKeys("e","a");e.replaceRange(")",e.getCursor());n.doInsertModeKeys("Esc");n.doKeys("q");n.doKeys("w","@","z");n.doKeys("w","@","z");eq("(see) (spot) (run)",e.getValue())},{value:"see spot run"});testVim("macro_overwrite",function(e,t,n){e.setCursor(0,0);n.doKeys("q","z","0","i");e.replaceRange("I ",e.getCursor());n.doInsertModeKeys("Esc");n.doKeys("q");n.doKeys("e");n.doKeys("q","z","a");e.replaceRange(".",e.getCursor());n.doInsertModeKeys("Esc");n.doKeys("q");n.doKeys("e","@","z");n.doKeys("e","@","z");eq("I see. spot. run.",e.getValue())},{value:"see spot run"});testVim("macro_search_f",function(e,t,n){e.setCursor(0,0);n.doKeys("q","a","f"," ");n.assertCursorAt(0,3);n.doKeys("q","0");n.assertCursorAt(0,0);n.doKeys("@","a");n.assertCursorAt(0,3)},{value:"The quick brown fox jumped over the lazy dog."});testVim("macro_search_2f",function(e,t,n){e.setCursor(0,0);n.doKeys("q","a","2","f"," ");n.assertCursorAt(0,9);n.doKeys("q","0");n.assertCursorAt(0,0);n.doKeys("@","a");n.assertCursorAt(0,9)},{value:"The quick brown fox jumped over the lazy dog."});testVim("yank_register",function(e,t,n){e.setCursor(0,0);n.doKeys('"',"a","y","y");n.doKeys("j",'"',"b","y","y");e.openDialog=n.fakeOpenDialog("registers");e.openNotification=n.fakeOpenNotification(function(e){is(/a\s+foo/.test(e));is(/b\s+bar/.test(e))});n.doKeys(":")},{value:"foo\nbar"});testVim("yank_append_line_to_line_register",function(e,t,n){e.setCursor(0,0);n.doKeys('"',"a","y","y");n.doKeys("j",'"',"A","y","y");e.openDialog=n.fakeOpenDialog("registers");e.openNotification=n.fakeOpenNotification(function(e){is(/a\s+foo\nbar/.test(e));is(/"\s+foo\nbar/.test(e))});n.doKeys(":")},{value:"foo\nbar"});testVim("yank_append_word_to_word_register",function(e,t,n){e.setCursor(0,0);n.doKeys('"',"a","y","w");n.doKeys("j",'"',"A","y","w");e.openDialog=n.fakeOpenDialog("registers");e.openNotification=n.fakeOpenNotification(function(e){is(/a\s+foobar/.test(e));is(/"\s+foobar/.test(e))});n.doKeys(":")},{value:"foo\nbar"});testVim("yank_append_line_to_word_register",function(e,t,n){e.setCursor(0,0);n.doKeys('"',"a","y","w");n.doKeys("j",'"',"A","y","y");e.openDialog=n.fakeOpenDialog("registers");e.openNotification=n.fakeOpenNotification(function(e){is(/a\s+foo\nbar/.test(e));is(/"\s+foo\nbar/.test(e))});n.doKeys(":")},{value:"foo\nbar"});testVim("yank_append_word_to_line_register",function(e,t,n){e.setCursor(0,0);n.doKeys('"',"a","y","y");n.doKeys("j",'"',"A","y","w");e.openDialog=n.fakeOpenDialog("registers");e.openNotification=n.fakeOpenNotification(function(e){is(/a\s+foo\nbar/.test(e));is(/"\s+foo\nbar/.test(e))});n.doKeys(":")},{value:"foo\nbar"});testVim("macro_register",function(e,t,n){e.setCursor(0,0);n.doKeys("q","a","i");e.replaceRange("gangnam",e.getCursor());n.doInsertModeKeys("Esc");n.doKeys("q");n.doKeys("q","b","o");e.replaceRange("style",e.getCursor());n.doInsertModeKeys("Esc");n.doKeys("q");e.openDialog=n.fakeOpenDialog("registers");e.openNotification=n.fakeOpenNotification(function(e){is(/a\s+i/.test(e));is(/b\s+o/.test(e))});n.doKeys(":")},{value:""});testVim("._register",function(e,t,n){e.setCursor(0,0);n.doKeys("i");e.replaceRange("foo",e.getCursor());n.doInsertModeKeys("Esc");e.openDialog=n.fakeOpenDialog("registers");e.openNotification=n.fakeOpenNotification(function(e){is(/\.\s+foo/.test(e))});n.doKeys(":")},{value:""});testVim(":_register",function(e,t,n){n.doEx("bar");e.openDialog=n.fakeOpenDialog("registers");e.openNotification=n.fakeOpenNotification(function(e){is(/:\s+bar/.test(e))});n.doKeys(":")},{value:""});testVim(".",function(e,t,n){e.setCursor(0,0);n.doKeys("2","d","w");n.doKeys(".");eq("5 6",e.getValue())},{value:"1 2 3 4 5 6"});testVim("._repeat",function(e,t,n){e.setCursor(0,0);n.doKeys("2","d","w");n.doKeys("3",".");eq("6",e.getValue())},{value:"1 2 3 4 5 6"});testVim("._insert",function(e,t,n){n.doKeys("i");e.replaceRange("test",e.getCursor());n.doInsertModeKeys("Esc");n.doKeys(".");eq("testestt",e.getValue());n.assertCursorAt(0,6)},{value:""});testVim("._insert_repeat",function(e,t,n){n.doKeys("i");e.replaceRange("test",e.getCursor());e.setCursor(0,4);n.doInsertModeKeys("Esc");n.doKeys("2",".");eq("testesttestt",e.getValue());n.assertCursorAt(0,10)},{value:""});testVim("._repeat_insert",function(e,t,n){n.doKeys("3","i");e.replaceRange("te",e.getCursor());e.setCursor(0,2);n.doInsertModeKeys("Esc");n.doKeys(".");eq("tetettetetee",e.getValue());n.assertCursorAt(0,10)},{value:""});testVim("._insert_o",function(e,t,n){n.doKeys("o");e.replaceRange("z",e.getCursor());e.setCursor(1,1);n.doInsertModeKeys("Esc");n.doKeys(".");eq("\nz\nz",e.getValue());n.assertCursorAt(2,0)},{value:""});testVim("._insert_o_repeat",function(e,t,n){n.doKeys("o");e.replaceRange("z",e.getCursor());n.doInsertModeKeys("Esc");e.setCursor(1,0);n.doKeys("2",".");eq("\nz\nz\nz",e.getValue());n.assertCursorAt(3,0)},{value:""});testVim("._insert_o_indent",function(e,t,n){n.doKeys("o");e.replaceRange("z",e.getCursor());n.doInsertModeKeys("Esc");e.setCursor(1,2);n.doKeys(".");eq("{\n  z\n  z",e.getValue());n.assertCursorAt(2,2)},{value:"{"});testVim("._insert_cw",function(e,t,n){n.doKeys("c","w");e.replaceRange("test",e.getCursor());n.doInsertModeKeys("Esc");e.setCursor(0,3);n.doKeys("2","l");n.doKeys(".");eq("test test word3",e.getValue());n.assertCursorAt(0,8)},{value:"word1 word2 word3"});testVim("._insert_cw_repeat",function(e,t,n){n.doKeys("c","w");e.replaceRange("test",e.getCursor());n.doInsertModeKeys("Esc");e.setCursor(0,4);n.doKeys("l");n.doKeys("2",".");eq("test test",e.getValue());n.assertCursorAt(0,8)},{value:"word1 word2 word3"});testVim("._delete",function(e,t,n){e.setCursor(0,5);n.doKeys("i");n.doInsertModeKeys("Backspace","Esc");n.doKeys(".");eq("zace",e.getValue());n.assertCursorAt(0,1)},{value:"zabcde"});testVim("._delete_repeat",function(e,t,n){e.setCursor(0,6);n.doKeys("i");n.doInsertModeKeys("Backspace","Esc");n.doKeys("2",".");eq("zzce",e.getValue());n.assertCursorAt(0,1)},{value:"zzabcde"});testVim("f;",function(e,t,n){e.setCursor(0,0);n.doKeys("f","x");n.doKeys(";");n.doKeys("2",";");eq(9,e.getCursor().ch)},{value:"01x3xx678x"});testVim("F;",function(e,t,n){e.setCursor(0,8);n.doKeys("F","x");n.doKeys(";");n.doKeys("2",";");eq(2,e.getCursor().ch)},{value:"01x3xx6x8x"});testVim("t;",function(e,t,n){e.setCursor(0,0);n.doKeys("t","x");n.doKeys(";");n.doKeys("2",";");eq(8,e.getCursor().ch)},{value:"01x3xx678x"});testVim("T;",function(e,t,n){e.setCursor(0,9);n.doKeys("T","x");n.doKeys(";");n.doKeys("2",";");eq(2,e.getCursor().ch)},{value:"0xx3xx678x"});testVim("f,",function(e,t,n){e.setCursor(0,6);n.doKeys("f","x");n.doKeys(",");n.doKeys("2",",");eq(2,e.getCursor().ch)},{value:"01x3xx678x"});testVim("F,",function(e,t,n){e.setCursor(0,3);n.doKeys("F","x");n.doKeys(",");n.doKeys("2",",");eq(9,e.getCursor().ch)},{value:"01x3xx678x"});testVim("t,",function(e,t,n){e.setCursor(0,6);n.doKeys("t","x");n.doKeys(",");n.doKeys("2",",");eq(3,e.getCursor().ch)},{value:"01x3xx678x"});testVim("T,",function(e,t,n){e.setCursor(0,4);n.doKeys("T","x");n.doKeys(",");n.doKeys("2",",");eq(8,e.getCursor().ch)},{value:"01x3xx67xx"});testVim("fd,;",function(e,t,n){e.setCursor(0,0);n.doKeys("f","4");e.setCursor(0,0);n.doKeys("d",";");eq("56789",e.getValue());n.doKeys("u");e.setCursor(0,9);n.doKeys("d",",");eq("01239",e.getValue())},{value:"0123456789"});testVim("Fd,;",function(e,t,n){e.setCursor(0,9);n.doKeys("F","4");e.setCursor(0,9);n.doKeys("d",";");eq("01239",e.getValue());n.doKeys("u");e.setCursor(0,0);n.doKeys("d",",");eq("56789",e.getValue())},{value:"0123456789"});testVim("td,;",function(e,t,n){e.setCursor(0,0);n.doKeys("t","4");e.setCursor(0,0);n.doKeys("d",";");eq("456789",e.getValue());n.doKeys("u");e.setCursor(0,9);n.doKeys("d",",");eq("012349",e.getValue())},{value:"0123456789"});testVim("Td,;",function(e,t,n){e.setCursor(0,9);n.doKeys("T","4");e.setCursor(0,9);n.doKeys("d",";");eq("012349",e.getValue());n.doKeys("u");e.setCursor(0,0);n.doKeys("d",",");eq("456789",e.getValue())},{value:"0123456789"});testVim("fc,;",function(e,t,n){e.setCursor(0,0);n.doKeys("f","4");e.setCursor(0,0);n.doKeys("c",";","Esc");eq("56789",e.getValue());n.doKeys("u");e.setCursor(0,9);n.doKeys("c",",");eq("01239",e.getValue())},{value:"0123456789"});testVim("Fc,;",function(e,t,n){e.setCursor(0,9);n.doKeys("F","4");e.setCursor(0,9);n.doKeys("c",";","Esc");eq("01239",e.getValue());n.doKeys("u");e.setCursor(0,0);n.doKeys("c",",");eq("56789",e.getValue())},{value:"0123456789"});testVim("tc,;",function(e,t,n){e.setCursor(0,0);n.doKeys("t","4");e.setCursor(0,0);n.doKeys("c",";","Esc");eq("456789",e.getValue());n.doKeys("u");e.setCursor(0,9);n.doKeys("c",",");eq("012349",e.getValue())},{value:"0123456789"});testVim("Tc,;",function(e,t,n){e.setCursor(0,9);n.doKeys("T","4");e.setCursor(0,9);n.doKeys("c",";","Esc");eq("012349",e.getValue());n.doKeys("u");e.setCursor(0,0);n.doKeys("c",",");eq("456789",e.getValue())},{value:"0123456789"});testVim("fy,;",function(e,t,n){e.setCursor(0,0);n.doKeys("f","4");e.setCursor(0,0);n.doKeys("y",";","P");eq("012340123456789",e.getValue());n.doKeys("u");e.setCursor(0,9);n.doKeys("y",",","P");eq("012345678456789",e.getValue())},{value:"0123456789"});testVim("Fy,;",function(e,t,n){e.setCursor(0,9);n.doKeys("F","4");e.setCursor(0,9);n.doKeys("y",";","p");eq("012345678945678",e.getValue());n.doKeys("u");e.setCursor(0,0);n.doKeys("y",",","P");eq("012340123456789",e.getValue())},{value:"0123456789"});testVim("ty,;",function(e,t,n){e.setCursor(0,0);n.doKeys("t","4");e.setCursor(0,0);n.doKeys("y",";","P");eq("01230123456789",e.getValue());n.doKeys("u");e.setCursor(0,9);n.doKeys("y",",","p");eq("01234567895678",e.getValue())},{value:"0123456789"});testVim("Ty,;",function(e,t,n){e.setCursor(0,9);n.doKeys("T","4");e.setCursor(0,9);n.doKeys("y",";","p");eq("01234567895678",e.getValue());n.doKeys("u");e.setCursor(0,0);n.doKeys("y",",","P");eq("01230123456789",e.getValue())},{value:"0123456789"});testVim("HML",function(e,t,n){var r=35;var i=e.defaultTextHeight();e.setSize(600,r*i);e.setCursor(120,0);n.doKeys("H");n.assertCursorAt(86,2);n.doKeys("L");n.assertCursorAt(120,4);n.doKeys("M");n.assertCursorAt(103,4)},{value:function(){var e=new Array(100);var t="  xx\n";var n="    xx\n";t=e.join(t);n=e.join(n);return t+n}()});var zVals=["zb","zz","zt","z-","z.","z<CR>"].map(function(e,t){var n=250;var r=35;testVim(e,function(i,s,o){var u=e[0];var a=e.substring(1);var f=i.defaultTextHeight();i.setSize(600,r*f);i.setCursor(n,0);o.doKeys(u,a);zVals[t]=i.getScrollInfo().top},{value:function(){return(new Array(500)).join("\n")}()})});testVim("zb<zz",function(e,t,n){eq(zVals[0]<zVals[1],true)});testVim("zz<zt",function(e,t,n){eq(zVals[1]<zVals[2],true)});testVim("zb==z-",function(e,t,n){eq(zVals[0],zVals[3])});testVim("zz==z.",function(e,t,n){eq(zVals[1],zVals[4])});testVim("zt==z<CR>",function(e,t,n){eq(zVals[2],zVals[5])});var moveTillCharacterSandbox="The quick brown fox \n";"jumped over the lazy dog.";testVim("moveTillCharacter",function(e,t,n){e.setCursor(0,0);e.openDialog=n.fakeOpenDialog("q");n.doKeys("/");eq(4,e.getCursor().ch);n.doKeys("t");n.doKeys("o");eq("The quick brown fox \n",e.getValue());n.doKeys("d");n.doKeys("t");n.doKeys("o");eq("The quick bown fox \n",e.getValue());n.doKeys(".");eq("The quick box \n",e.getValue());n.doKeys("d");n.doKeys("t");n.doKeys("q");eq("The quick box \n",e.getValue());n.doKeys("d");n.doKeys("t");n.doKeys("z");eq("The quick box \n",e.getValue());n.doKeys("d");n.doKeys("N");eq("The ox \n",e.getValue());eq(4,e.getCursor().ch)},{value:moveTillCharacterSandbox});testVim("searchForPipe",function(e,t,n){CodeMirror.Vim.setOption("pcre",false);e.setCursor(0,0);e.openDialog=n.fakeOpenDialog("|");n.doKeys("/");eq(4,e.getCursor().ch)},{value:"this|that"});var scrollMotionSandbox="\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n";"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n";"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n";"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n";testVim("scrollMotion",function(e,t,n){var r,i;e.setCursor(0,0);n.doKeys("<C-y>");eq(0,e.getCursor().line);i=e.getScrollInfo();n.doKeys("<C-e>");eq(1,e.getCursor().line);is(i.top<e.getScrollInfo().top);e.setCursor(1e3,0);r=e.getCursor();n.doKeys("<C-e>");eq(r.line,e.getCursor().line);i=e.getScrollInfo();n.doKeys("<C-y>");eq(r.line-1,e.getCursor().line);is(i.top>e.getScrollInfo().top)},{value:scrollMotionSandbox});var squareBracketMotionSandbox=""+"({\n"+"  ({\n"+"  /*comment {\n"+"            */(\n"+"#else                \n"+"  /*       )\n"+"#if        }\n"+"  )}*/\n"+")}\n"+"{}\n"+"#else {{\n"+"{}\n"+"}\n"+"{\n"+"#endif\n"+"}\n"+"}\n"+"#else";testVim("[[, ]]",function(e,t,n){e.setCursor(0,0);n.doKeys("]","]");n.assertCursorAt(9,0);n.doKeys("2","]","]");n.assertCursorAt(13,0);n.doKeys("]","]");n.assertCursorAt(17,0);n.doKeys("[","[");n.assertCursorAt(13,0);n.doKeys("2","[","[");n.assertCursorAt(9,0);n.doKeys("[","[");n.assertCursorAt(0,0)},{value:squareBracketMotionSandbox});testVim("[], ][",function(e,t,n){e.setCursor(0,0);n.doKeys("]","[");n.assertCursorAt(12,0);n.doKeys("2","]","[");n.assertCursorAt(16,0);n.doKeys("]","[");n.assertCursorAt(17,0);n.doKeys("[","]");n.assertCursorAt(16,0);n.doKeys("2","[","]");n.assertCursorAt(12,0);n.doKeys("[","]");n.assertCursorAt(0,0)},{value:squareBracketMotionSandbox});testVim("[{, ]}",function(e,t,n){e.setCursor(4,10);n.doKeys("[","{");n.assertCursorAt(2,12);n.doKeys("2","[","{");n.assertCursorAt(0,1);e.setCursor(4,10);n.doKeys("]","}");n.assertCursorAt(6,11);n.doKeys("2","]","}");n.assertCursorAt(8,1);e.setCursor(0,1);n.doKeys("]","}");n.assertCursorAt(8,1);n.doKeys("[","{");n.assertCursorAt(0,1)},{value:squareBracketMotionSandbox});testVim("[(, ])",function(e,t,n){e.setCursor(4,10);n.doKeys("[","(");n.assertCursorAt(3,14);n.doKeys("2","[","(");n.assertCursorAt(0,0);e.setCursor(4,10);n.doKeys("]",")");n.assertCursorAt(5,11);n.doKeys("2","]",")");n.assertCursorAt(8,0);n.doKeys("[","(");n.assertCursorAt(0,0);n.doKeys("]",")");n.assertCursorAt(8,0)},{value:squareBracketMotionSandbox});testVim("[*, ]*, [/, ]/",function(e,t,n){forEach(["*","/"],function(t){e.setCursor(7,0);n.doKeys("2","[",t);n.assertCursorAt(2,2);n.doKeys("2","]",t);n.assertCursorAt(7,5)})},{value:squareBracketMotionSandbox});testVim("[#, ]#",function(e,t,n){e.setCursor(10,3);n.doKeys("2","[","#");n.assertCursorAt(4,0);n.doKeys("5","]","#");n.assertCursorAt(17,0);e.setCursor(10,3);n.doKeys("]","#");n.assertCursorAt(14,0)},{value:squareBracketMotionSandbox});testVim("[m, ]m, [M, ]M",function(e,t,n){e.setCursor(11,0);n.doKeys("[","m");n.assertCursorAt(10,7);n.doKeys("4","[","m");n.assertCursorAt(1,3);n.doKeys("5","]","m");n.assertCursorAt(11,0);n.doKeys("[","M");n.assertCursorAt(9,1);n.doKeys("3","]","M");n.assertCursorAt(15,0);n.doKeys("5","[","M");n.assertCursorAt(7,3)},{value:squareBracketMotionSandbox});testVim("ex_go_to_line",function(e,t,n){e.setCursor(0,0);n.doEx("4");n.assertCursorAt(3,0)},{value:"a\nb\nc\nd\ne\n"});testVim("ex_write",function(e,t,n){var r=CodeMirror.commands.save;var i;var s;CodeMirror.commands.save=function(e){i=true;s=e};var o="write";for(var u=1;u<o.length;u++){i=false;s=null;n.doEx(o.substring(0,u));eq(i,true);eq(s,e)}CodeMirror.commands.save=r});testVim("ex_sort",function(e,t,n){n.doEx("sort");eq("Z\na\nb\nc\nd",e.getValue())},{value:"b\nZ\nd\nc\na"});testVim("ex_sort_reverse",function(e,t,n){n.doEx("sort!");eq("d\nc\nb\na",e.getValue())},{value:"b\nd\nc\na"});testVim("ex_sort_range",function(e,t,n){n.doEx("2,3sort");eq("b\nc\nd\na",e.getValue())},{value:"b\nd\nc\na"});testVim("ex_sort_oneline",function(e,t,n){n.doEx("2sort");eq("b\nd\nc\na",e.getValue())},{value:"b\nd\nc\na"});testVim("ex_sort_ignoreCase",function(e,t,n){n.doEx("sort i");eq("a\nb\nc\nd\nZ",e.getValue())},{value:"b\nZ\nd\nc\na"});testVim("ex_sort_unique",function(e,t,n){n.doEx("sort u");eq("Z\na\nb\nc\nd",e.getValue())},{value:"b\nZ\na\na\nd\na\nc\na"});testVim("ex_sort_decimal",function(e,t,n){n.doEx("sort d");eq("d3\n s5\n6\n.9",e.getValue())},{value:"6\nd3\n s5\n.9"});testVim("ex_sort_decimal_negative",function(e,t,n){n.doEx("sort d");eq("z-9\nd3\n s5\n6\n.9",e.getValue())},{value:"6\nd3\n s5\n.9\nz-9"});testVim("ex_sort_decimal_reverse",function(e,t,n){n.doEx("sort! d");eq(".9\n6\n s5\nd3",e.getValue())},{value:"6\nd3\n s5\n.9"});testVim("ex_sort_hex",function(e,t,n){n.doEx("sort x");eq(" s5\n6\n.9\n&0xB\nd3",e.getValue())},{value:"6\nd3\n s5\n&0xB\n.9"});testVim("ex_sort_octal",function(e,t,n){n.doEx("sort o");eq(".8\n.9\nd3\n s5\n6",e.getValue())},{value:"6\nd3\n s5\n.9\n.8"});testVim("ex_sort_decimal_mixed",function(e,t,n){n.doEx("sort d");eq("y\nz\nc1\nb2\na3",e.getValue())},{value:"a3\nz\nc1\ny\nb2"});testVim("ex_sort_decimal_mixed_reverse",function(e,t,n){n.doEx("sort! d");eq("a3\nb2\nc1\nz\ny",e.getValue())},{value:"a3\nz\nc1\ny\nb2"});testVim("ex_substitute_same_line",function(e,t,n){e.setCursor(1,0);n.doEx("s/one/two");eq("one one\n two two",e.getValue())},{value:"one one\n one one"});testVim("ex_substitute_global",function(e,t,n){e.setCursor(1,0);n.doEx("%s/one/two");eq("two two\n two two",e.getValue())},{value:"one one\n one one"});testVim("ex_substitute_input_range",function(e,t,n){e.setCursor(1,0);n.doEx("1,3s/\\d/0");eq("0\n0\n0\n4",e.getValue())},{value:"1\n2\n3\n4"});testVim("ex_substitute_visual_range",function(e,t,n){e.setCursor(1,0);n.doKeys("V","2","j","v");n.doEx("'<,'>s/\\d/0");eq("1\n0\n0\n0\n5",e.getValue())},{value:"1\n2\n3\n4\n5"});testVim("ex_substitute_empty_query",function(e,t,n){e.setCursor(1,0);e.openDialog=n.fakeOpenDialog("1");n.doKeys("/");n.doEx("s//b");eq("abb ab2 ab3",e.getValue())},{value:"a11 a12 a13"});testVim("ex_substitute_javascript",function(e,t,n){CodeMirror.Vim.setOption("pcre",false);e.setCursor(1,0);n.doEx("s/\\(\\d+\\)/$$ $' $` $& \\1/");eq("a $$ $' $` $& 0 b",e.getValue())},{value:"a 0 b"});testVim("ex_substitute_empty_arguments",function(e,t,n){e.setCursor(0,0);n.doEx("s/a/b");e.setCursor(1,0);n.doEx("s");eq("b b\nb b",e.getValue())},{value:"a a\na a"});testSubstitute("ex_substitute_capture",{value:"a11 a12 a13",expectedValue:"a1111 a1212 a1313",expr:"s/(\\d+)/$1$1/",noPcreExpr:"s/\\(\\d+\\)/\\1\\1/"});testSubstitute("ex_substitute_capture2",{value:"a 0 b",expectedValue:"a $00 b",expr:"s/(\\d+)/$$$1$1/",noPcreExpr:"s/\\(\\d+\\)/$\\1\\1/"});testSubstitute("ex_substitute_nocapture",{value:"a11 a12 a13",expectedValue:"a$1$1 a$1$1 a$1$1",expr:"s/(\\d+)/$$1$$1",noPcreExpr:"s/\\(\\d+\\)/$1$1/"});testSubstitute("ex_substitute_nocapture2",{value:"a 0 b",expectedValue:"a $10 b",expr:"s/(\\d+)/$$1$1",noPcreExpr:"s/\\(\\d+\\)/\\$1\\1/"});testSubstitute("ex_substitute_nocapture",{value:"a b c",expectedValue:"a $ c",expr:"s/b/$$/",noPcreExpr:"s/b/$/"});testSubstitute("ex_substitute_slash_regex",{value:"one/two \n three/four",expectedValue:"one|two \n three|four",expr:"%s/\\//|"});testSubstitute("ex_substitute_pipe_regex",{value:"one|two \n three|four",expectedValue:"one,two \n three,four",expr:"%s/\\|/,/",noPcreExpr:"%s/|/,/"});testSubstitute("ex_substitute_or_regex",{value:"one|two \n three|four",expectedValue:"ana|twa \n thraa|faar",expr:"%s/o|e|u/a",noPcreExpr:"%s/o\\|e\\|u/a"});testSubstitute("ex_substitute_or_word_regex",{value:"one|two \n three|four",expectedValue:"five|five \n three|four",expr:"%s/(one|two)/five/",noPcreExpr:"%s/\\(one\\|two\\)/five"});testSubstitute("ex_substitute_backslashslash_regex",{value:"one\\two \n three\\four",expectedValue:"one,two \n three,four",expr:"%s/\\\\/,"});testSubstitute("ex_substitute_slash_replacement",{value:"one,two \n three,four",expectedValue:"one/two \n three/four",expr:"%s/,/\\/"});testSubstitute("ex_substitute_backslash_replacement",{value:"one,two \n three,four",expectedValue:"one\\two \n three\\four",expr:"%s/,/\\\\/g"});testSubstitute("ex_substitute_multibackslash_replacement",{value:"one,two \n three,four",expectedValue:"one\\\\\\\\two \n three\\\\\\\\four",expr:"%s/,/\\\\\\\\\\\\\\\\/g"});testSubstitute("ex_substitute_braces_word",{value:"ababab abb ab{2}",expectedValue:"ab abb ab{2}",expr:"%s/(ab){2}//g",noPcreExpr:"%s/\\(ab\\)\\{2\\}//g"});testSubstitute("ex_substitute_braces_range",{value:"a aa aaa aaaa",expectedValue:"a   a",expr:"%s/a{2,3}//g",noPcreExpr:"%s/a\\{2,3\\}//g"});testSubstitute("ex_substitute_braces_literal",{value:"ababab abb ab{2}",expectedValue:"ababab abb ",expr:"%s/ab\\{2\\}//g",noPcreExpr:"%s/ab{2}//g"});testSubstitute("ex_substitute_braces_char",{value:"ababab abb ab{2}",expectedValue:"ababab  ab{2}",expr:"%s/ab{2}//g",noPcreExpr:"%s/ab\\{2\\}//g"});testSubstitute("ex_substitute_braces_no_escape",{value:"ababab abb ab{2}",expectedValue:"ababab  ab{2}",expr:"%s/ab{2}//g",noPcreExpr:"%s/ab\\{2}//g"});testSubstitute("ex_substitute_count",{value:"1\n2\n3\n4",expectedValue:"1\n0\n0\n4",expr:"s/\\d/0/i 2"});testSubstitute("ex_substitute_count_with_range",{value:"1\n2\n3\n4",expectedValue:"1\n2\n0\n0",expr:"1,3s/\\d/0/ 3"});testSubstituteConfirm("ex_substitute_confirm_emptydoc","%s/x/b/c","","","",makeCursor(0,0));testSubstituteConfirm("ex_substitute_confirm_nomatch","%s/x/b/c","ba a\nbab","ba a\nbab","",makeCursor(0,0));testSubstituteConfirm("ex_substitute_confirm_accept","%s/a/b/c","ba a\nbab","bb b\nbbb","yyy",makeCursor(1,1));testSubstituteConfirm("ex_substitute_confirm_random_keys","%s/a/b/c","ba a\nbab","bb b\nbbb","ysdkywerty",makeCursor(1,1));testSubstituteConfirm("ex_substitute_confirm_some","%s/a/b/c","ba a\nbab","bb a\nbbb","yny",makeCursor(1,1));testSubstituteConfirm("ex_substitute_confirm_all","%s/a/b/c","ba a\nbab","bb b\nbbb","a",makeCursor(1,1));testSubstituteConfirm("ex_substitute_confirm_accept_then_all","%s/a/b/c","ba a\nbab","bb b\nbbb","ya",makeCursor(1,1));testSubstituteConfirm("ex_substitute_confirm_quit","%s/a/b/c","ba a\nbab","bb a\nbab","yq",makeCursor(0,3));testSubstituteConfirm("ex_substitute_confirm_last","%s/a/b/c","ba a\nbab","bb b\nbab","yl",makeCursor(0,3));testSubstituteConfirm("ex_substitute_confirm_oneline","1s/a/b/c","ba a\nbab","bb b\nbab","yl",makeCursor(0,3));testSubstituteConfirm("ex_substitute_confirm_range_accept","1,2s/a/b/c","aa\na \na\na","bb\nb \na\na","yyy",makeCursor(1,0));testSubstituteConfirm("ex_substitute_confirm_range_some","1,3s/a/b/c","aa\na \na\na","ba\nb \nb\na","ynyy",makeCursor(2,0));testSubstituteConfirm("ex_substitute_confirm_range_all","1,3s/a/b/c","aa\na \na\na","bb\nb \nb\na","a",makeCursor(2,0));testSubstituteConfirm("ex_substitute_confirm_range_last","1,3s/a/b/c","aa\na \na\na","bb\nb \na\na","yyl",makeCursor(1,0));testVim("ex_noh_clearSearchHighlight",function(e,t,n){e.openDialog=n.fakeOpenDialog("match");n.doKeys("?");n.doEx("noh");eq(t.searchState_.getOverlay(),null,"match-highlighting wasn't cleared");n.doKeys("n");n.assertCursorAt(0,11,"can't resume search after clearing highlighting")},{value:"match nope match \n nope Match"});testVim("set_boolean",function(e,t,n){CodeMirror.Vim.defineOption("testoption",true,"boolean");is(CodeMirror.Vim.getOption("testoption"));try{CodeMirror.Vim.setOption("testoption","5");fail()}catch(r){}CodeMirror.Vim.setOption("testoption",false);is(!CodeMirror.Vim.getOption("testoption"))});testVim("ex_set_boolean",function(e,t,n){CodeMirror.Vim.defineOption("testoption",true,"boolean");is(CodeMirror.Vim.getOption("testoption"));try{n.doEx("set testoption=22");fail()}catch(r){}n.doEx("set notestoption");is(!CodeMirror.Vim.getOption("testoption"))});testVim("set_string",function(e,t,n){CodeMirror.Vim.defineOption("testoption","a","string");eq("a",CodeMirror.Vim.getOption("testoption"));try{CodeMirror.Vim.setOption("testoption",true);fail()}catch(r){}try{CodeMirror.Vim.setOption("notestoption","b");fail()}catch(r){}CodeMirror.Vim.setOption("testoption","c");eq("c",CodeMirror.Vim.getOption("testoption"))});testVim("ex_set_string",function(e,t,n){CodeMirror.Vim.defineOption("testoption","a","string");eq("a",CodeMirror.Vim.getOption("testoption"));try{n.doEx("set notestoption=b");fail()}catch(r){}n.doEx("set testoption=c");eq("c",CodeMirror.Vim.getOption("testoption"))});testVim("ex_map_key2key",function(e,t,n){n.doEx("map a x");n.doKeys("a");n.assertCursorAt(0,0);eq("bc",e.getValue())},{value:"abc"});testVim("ex_unmap_key2key",function(e,t,n){n.doEx("unmap a");n.doKeys("a");eq("vim-insert",e.getOption("keyMap"))},{value:"abc"});testVim("ex_unmap_key2key_does_not_remove_default",function(e,t,n){try{n.doEx("unmap a");fail()}catch(r){}n.doKeys("a");eq("vim-insert",e.getOption("keyMap"))},{value:"abc"});testVim("ex_map_key2key_to_colon",function(e,t,n){n.doEx("map ; :");var r=false;e.openDialog=function(){r=true};n.doKeys(";");eq(r,true)});testVim("ex_map_ex2key:",function(e,t,n){n.doEx("map :del x");n.doEx("del");n.assertCursorAt(0,0);eq("bc",e.getValue())},{value:"abc"});testVim("ex_map_ex2ex",function(e,t,n){n.doEx("map :del :w");var r=CodeMirror.commands.save;var i=false;var s;CodeMirror.commands.save=function(e){i=true;s=e};n.doEx("del");CodeMirror.commands.save=r;eq(i,true);eq(s,e)});testVim("ex_map_key2ex",function(e,t,n){n.doEx("map a :w");var r=CodeMirror.commands.save;var i=false;var s;CodeMirror.commands.save=function(e){i=true;s=e};n.doKeys("a");CodeMirror.commands.save=r;eq(i,true);eq(s,e)});testVim("ex_map_key2key_visual_api",function(e,t,n){CodeMirror.Vim.map("b",":w","visual");var r=CodeMirror.commands.save;var i=false;var s;CodeMirror.commands.save=function(e){i=true;s=e};n.doKeys("b");eq(i,false);n.doKeys("v","b");eq(i,true);eq(s,e);CodeMirror.commands.save=r});testVim("ex_api_test",function(e,t,n){var r=false;var i="from";CodeMirror.Vim.defineEx("extest","ext",function(e,t){if(t.args)i=t.args[0];else r=true});n.doEx(":ext to");eq(i,"to","Defining ex-command failed");CodeMirror.Vim.map("<C-CR><Space>",":ext");n.doKeys("<C-CR>","<Space>");is(r,"Mapping to key failed")});testVim("ex_map_key2key_from_colon",function(e,t,n){n.doEx("map : x");n.doKeys(":");n.assertCursorAt(0,0);eq("bc",e.getValue())},{value:"abc"});testVim("beforeSelectionChange",function(e,t,n){e.setCursor(0,100);eqPos(e.getCursor("head"),e.getCursor("anchor"))},{value:"abc"})