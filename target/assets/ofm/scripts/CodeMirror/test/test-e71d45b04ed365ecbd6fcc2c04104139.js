function forEach(e,t){for(var n=0,r=e.length;n<r;++n)t(e[n])}function addDoc(e,t,n){var r=[],i="";for(var s=0;s<t;++s)i+="x";for(var s=0;s<n;++s)r.push(i);e.setValue(r.join("\n"))}function byClassName(e,t){function i(e){if(e.nodeType==3)return;if(r.test(e.className))n.push(e);for(var t=0,s=e.childNodes.length;t<s;++t)i(e.childNodes[t])}if(e.getElementsByClassName)return e.getElementsByClassName(t);var n=[],r=new RegExp("\\b"+t+"\\b");i(e);return n}function foldLines(e,t,n,r){return e.markText(Pos(t,0),Pos(n-1),{inclusiveLeft:true,inclusiveRight:true,collapsed:true,clearOnEnter:r})}var Pos=CodeMirror.Pos;CodeMirror.defaults.rtlMoveVisually=true;var ie_lt8=/MSIE [1-7]\b/.test(navigator.userAgent);var ie_lt9=/MSIE [1-8]\b/.test(navigator.userAgent);var mac=/Mac/.test(navigator.platform);var phantom=/PhantomJS/.test(navigator.userAgent);var opera=/Opera\/\./.test(navigator.userAgent);var opera_version=opera&&navigator.userAgent.match(/Version\/(\d+\.\d+)/);if(opera_version)opera_version=Number(opera_version);var opera_lt10=opera&&(!opera_version||opera_version<10);namespace="core_";test("core_fromTextArea",function(){var e=document.getElementById("code");e.value="CONTENT";var t=CodeMirror.fromTextArea(e);is(!e.offsetHeight);eq(t.getValue(),"CONTENT");t.setValue("foo\nbar");eq(t.getValue(),"foo\nbar");t.save();is(/^foo\r?\nbar$/.test(e.value));t.setValue("xxx");t.toTextArea();is(e.offsetHeight);eq(e.value,"xxx")});testCM("getRange",function(e){eq(e.getLine(0),"1234");eq(e.getLine(1),"5678");eq(e.getLine(2),null);eq(e.getLine(-1),null);eq(e.getRange(Pos(0,0),Pos(0,3)),"123");eq(e.getRange(Pos(0,-1),Pos(0,200)),"1234");eq(e.getRange(Pos(0,2),Pos(1,2)),"34\n56");eq(e.getRange(Pos(1,2),Pos(100,0)),"78")},{value:"1234\n5678"});testCM("replaceRange",function(e){eq(e.getValue(),"");e.replaceRange("foo\n",Pos(0,0));eq(e.getValue(),"foo\n");e.replaceRange("a\nb",Pos(0,1));eq(e.getValue(),"fa\nboo\n");eq(e.lineCount(),3);e.replaceRange("xyzzy",Pos(0,0),Pos(1,1));eq(e.getValue(),"xyzzyoo\n");e.replaceRange("abc",Pos(0,0),Pos(10,0));eq(e.getValue(),"abc");eq(e.lineCount(),1)});testCM("selection",function(e){e.setSelection(Pos(0,4),Pos(2,2));is(e.somethingSelected());eq(e.getSelection(),"11\n222222\n33");eqPos(e.getCursor(false),Pos(2,2));eqPos(e.getCursor(true),Pos(0,4));e.setSelection(Pos(1,0));is(!e.somethingSelected());eq(e.getSelection(),"");eqPos(e.getCursor(true),Pos(1,0));e.replaceSelection("abc","around");eq(e.getSelection(),"abc");eq(e.getValue(),"111111\nabc222222\n333333");e.replaceSelection("def","end");eq(e.getSelection(),"");eqPos(e.getCursor(true),Pos(1,3));e.setCursor(Pos(2,1));eqPos(e.getCursor(true),Pos(2,1));e.setCursor(1,2);eqPos(e.getCursor(true),Pos(1,2))},{value:"111111\n222222\n333333"});testCM("extendSelection",function(e){e.setExtending(true);addDoc(e,10,10);e.setSelection(Pos(3,5));eqPos(e.getCursor("head"),Pos(3,5));eqPos(e.getCursor("anchor"),Pos(3,5));e.setSelection(Pos(2,5),Pos(5,5));eqPos(e.getCursor("head"),Pos(5,5));eqPos(e.getCursor("anchor"),Pos(2,5));eqPos(e.getCursor("start"),Pos(2,5));eqPos(e.getCursor("end"),Pos(5,5));e.setSelection(Pos(5,5),Pos(2,5));eqPos(e.getCursor("head"),Pos(2,5));eqPos(e.getCursor("anchor"),Pos(5,5));eqPos(e.getCursor("start"),Pos(2,5));eqPos(e.getCursor("end"),Pos(5,5));e.extendSelection(Pos(3,2));eqPos(e.getCursor("head"),Pos(3,2));eqPos(e.getCursor("anchor"),Pos(5,5));e.extendSelection(Pos(6,2));eqPos(e.getCursor("head"),Pos(6,2));eqPos(e.getCursor("anchor"),Pos(5,5));e.extendSelection(Pos(6,3),Pos(6,4));eqPos(e.getCursor("head"),Pos(6,4));eqPos(e.getCursor("anchor"),Pos(5,5));e.extendSelection(Pos(0,3),Pos(0,4));eqPos(e.getCursor("head"),Pos(0,3));eqPos(e.getCursor("anchor"),Pos(5,5));e.extendSelection(Pos(4,5),Pos(6,5));eqPos(e.getCursor("head"),Pos(6,5));eqPos(e.getCursor("anchor"),Pos(4,5));e.setExtending(false);e.extendSelection(Pos(0,3),Pos(0,4));eqPos(e.getCursor("head"),Pos(0,3));eqPos(e.getCursor("anchor"),Pos(0,4))});testCM("lines",function(e){eq(e.getLine(0),"111111");eq(e.getLine(1),"222222");eq(e.getLine(-1),null);e.replaceRange("",Pos(1,0),Pos(2,0));e.replaceRange("abc",Pos(1,0),Pos(1));eq(e.getValue(),"111111\nabc")},{value:"111111\n222222\n333333"});testCM("indent",function(e){e.indentLine(1);eq(e.getLine(1),"   blah();");e.setOption("indentUnit",8);e.indentLine(1);eq(e.getLine(1),"	blah();");e.setOption("indentUnit",10);e.setOption("tabSize",4);e.indentLine(1);eq(e.getLine(1),"		  blah();")},{value:"if (x) {\nblah();\n}",indentUnit:3,indentWithTabs:true,tabSize:8});testCM("indentByNumber",function(e){e.indentLine(0,2);eq(e.getLine(0),"  foo");e.indentLine(0,-200);eq(e.getLine(0),"foo");e.setSelection(Pos(0,0),Pos(1,2));e.indentSelection(3);eq(e.getValue(),"   foo\n   bar\nbaz")},{value:"foo\nbar\nbaz"});test("core_defaults",function(){var e={},t=CodeMirror.defaults;for(var n in t)e[n]=t[n];t.indentUnit=5;t.value="uu";t.indentWithTabs=true;t.tabindex=55;var r=document.getElementById("testground"),i=CodeMirror(r);try{eq(i.getOption("indentUnit"),5);i.setOption("indentUnit",10);eq(t.indentUnit,5);eq(i.getValue(),"uu");eq(i.getOption("indentWithTabs"),true);eq(i.getInputField().tabIndex,55)}finally{for(var n in e)t[n]=e[n];r.removeChild(i.getWrapperElement())}});testCM("lineInfo",function(e){eq(e.lineInfo(-1),null);var t=document.createElement("span");var n=e.setGutterMarker(1,"FOO",t);var r=e.lineInfo(1);eq(r.text,"222222");eq(r.gutterMarkers.FOO,t);eq(r.line,1);eq(e.lineInfo(2).gutterMarkers,null);e.setGutterMarker(n,"FOO",null);eq(e.lineInfo(1).gutterMarkers,null);e.setGutterMarker(1,"FOO",t);e.setGutterMarker(0,"FOO",t);e.clearGutter("FOO");eq(e.lineInfo(0).gutterMarkers,null);eq(e.lineInfo(1).gutterMarkers,null)},{value:"111111\n222222\n333333"});testCM("coords",function(e){e.setSize(null,100);addDoc(e,32,200);var t=e.charCoords(Pos(0,0));var n=e.charCoords(Pos(200,30));is(t.left<n.left);is(t.top<n.top);is(t.top<t.bottom);e.scrollTo(null,100);var r=e.charCoords(Pos(0,0));is(t.top>r.top);eq(t.left,r.left)});testCM("coordsChar",function(e){addDoc(e,35,70);for(var t=0;t<2;++t){var n=t?"local":"page";for(var r=0;r<=35;r+=5){for(var i=0;i<70;i+=5){e.setCursor(i,r);var s=e.charCoords(Pos(i,r),n);var o=e.coordsChar({left:s.left+1,top:s.top+1},n);eqPos(o,Pos(i,r))}}}},{lineNumbers:true});testCM("posFromIndex",function(e){e.setValue("This function should\n"+"convert a zero based index\n"+"to line and ch.");var t=[{index:-1,line:0,ch:0},{index:0,line:0,ch:0},{index:10,line:0,ch:10},{index:39,line:1,ch:18},{index:55,line:2,ch:7},{index:63,line:2,ch:15},{index:64,line:2,ch:15}];for(var n=0;n<t.length;n++){var r=t[n];var i=e.posFromIndex(r.index);eq(i.line,r.line);eq(i.ch,r.ch);if(r.index>=0&&r.index<64)eq(e.indexFromPos(i),r.index)}});testCM("undo",function(e){e.replaceRange("def",Pos(0,0),Pos(0));eq(e.historySize().undo,1);e.undo();eq(e.getValue(),"abc");eq(e.historySize().undo,0);eq(e.historySize().redo,1);e.redo();eq(e.getValue(),"def");eq(e.historySize().undo,1);eq(e.historySize().redo,0);e.setValue("1\n\n\n2");e.clearHistory();eq(e.historySize().undo,0);for(var t=0;t<20;++t){e.replaceRange("a",Pos(0,0));e.replaceRange("b",Pos(3,0))}eq(e.historySize().undo,40);for(var t=0;t<40;++t)e.undo();eq(e.historySize().redo,40);eq(e.getValue(),"1\n\n\n2")},{value:"abc"});testCM("undoDepth",function(e){e.replaceRange("d",Pos(0));e.replaceRange("e",Pos(0));e.replaceRange("f",Pos(0));e.undo();e.undo();e.undo();eq(e.getValue(),"abcd")},{value:"abc",undoDepth:4});testCM("undoDoesntClearValue",function(e){e.undo();eq(e.getValue(),"x")},{value:"x"});testCM("undoMultiLine",function(e){e.operation(function(){e.replaceRange("x",Pos(0,0));e.replaceRange("y",Pos(1,0))});e.undo();eq(e.getValue(),"abc\ndef\nghi");e.operation(function(){e.replaceRange("y",Pos(1,0));e.replaceRange("x",Pos(0,0))});e.undo();eq(e.getValue(),"abc\ndef\nghi");e.operation(function(){e.replaceRange("y",Pos(2,0));e.replaceRange("x",Pos(1,0));e.replaceRange("z",Pos(2,0))});e.undo();eq(e.getValue(),"abc\ndef\nghi",3)},{value:"abc\ndef\nghi"});testCM("undoComposite",function(e){e.replaceRange("y",Pos(1));e.operation(function(){e.replaceRange("x",Pos(0));e.replaceRange("z",Pos(2))});eq(e.getValue(),"ax\nby\ncz\n");e.undo();eq(e.getValue(),"a\nby\nc\n");e.undo();eq(e.getValue(),"a\nb\nc\n");e.redo();e.redo();eq(e.getValue(),"ax\nby\ncz\n")},{value:"a\nb\nc\n"});testCM("undoSelection",function(e){e.setSelection(Pos(0,2),Pos(0,4));e.replaceSelection("");e.setCursor(Pos(1,0));e.undo();eqPos(e.getCursor(true),Pos(0,2));eqPos(e.getCursor(false),Pos(0,4));e.setCursor(Pos(1,0));e.redo();eqPos(e.getCursor(true),Pos(0,2));eqPos(e.getCursor(false),Pos(0,2))},{value:"abcdefgh\n"});testCM("undoSelectionAsBefore",function(e){e.replaceSelection("abc","around");e.undo();e.redo();eq(e.getSelection(),"abc")});testCM("markTextSingleLine",function(e){forEach([{a:0,b:1,c:"",f:2,t:5},{a:0,b:4,c:"",f:0,t:2},{a:1,b:2,c:"x",f:3,t:6},{a:4,b:5,c:"",f:3,t:5},{a:4,b:5,c:"xx",f:3,t:7},{a:2,b:5,c:"",f:2,t:3},{a:2,b:5,c:"abcd",f:6,t:7},{a:2,b:6,c:"x",f:null,t:null},{a:3,b:6,c:"",f:null,t:null},{a:0,b:9,c:"hallo",f:null,t:null},{a:4,b:6,c:"x",f:3,t:4},{a:4,b:8,c:"",f:3,t:4},{a:6,b:6,c:"a",f:3,t:6},{a:8,b:9,c:"",f:3,t:6}],function(t){e.setValue("1234567890");var n=e.markText(Pos(0,3),Pos(0,6),{className:"foo"});e.replaceRange(t.c,Pos(0,t.a),Pos(0,t.b));var r=n.find();eq(r&&r.from.ch,t.f);eq(r&&r.to.ch,t.t)})});testCM("markTextMultiLine",function(e){function t(e){return e&&Pos(e[0],e[1])}forEach([{a:[0,0],b:[0,5],c:"",f:[0,0],t:[2,5]},{a:[0,0],b:[0,5],c:"foo\n",f:[1,0],t:[3,5]},{a:[0,1],b:[0,10],c:"",f:[0,1],t:[2,5]},{a:[0,5],b:[0,6],c:"x",f:[0,6],t:[2,5]},{a:[0,0],b:[1,0],c:"",f:[0,0],t:[1,5]},{a:[0,6],b:[2,4],c:"",f:[0,5],t:[0,7]},{a:[0,6],b:[2,4],c:"aa",f:[0,5],t:[0,9]},{a:[1,2],b:[1,8],c:"",f:[0,5],t:[2,5]},{a:[0,5],b:[2,5],c:"xx",f:null,t:null},{a:[0,0],b:[2,10],c:"x",f:null,t:null},{a:[1,5],b:[2,5],c:"",f:[0,5],t:[1,5]},{a:[2,0],b:[2,3],c:"",f:[0,5],t:[2,2]},{a:[2,5],b:[3,0],c:"a\nb",f:[0,5],t:[2,5]},{a:[2,3],b:[3,0],c:"x",f:[0,5],t:[2,3]},{a:[1,1],b:[1,9],c:"1\n2\n3",f:[0,5],t:[4,5]}],function(n){e.setValue("aaaaaaaaaa\nbbbbbbbbbb\ncccccccccc\ndddddddd\n");var r=e.markText(Pos(0,5),Pos(2,5),{className:"CodeMirror-matchingbracket"});e.replaceRange(n.c,t(n.a),t(n.b));var i=r.find();eqPos(i&&i.from,t(n.f));eqPos(i&&i.to,t(n.t))})});testCM("markTextUndo",function(e){var t,n,r;t=e.markText(Pos(0,1),Pos(0,3),{className:"CodeMirror-matchingbracket"});n=e.markText(Pos(0,0),Pos(2,1),{className:"CodeMirror-matchingbracket"});r=e.setBookmark(Pos(1,5));e.operation(function(){e.replaceRange("foo",Pos(0,2));e.replaceRange("bar\nbaz\nbug\n",Pos(2,0),Pos(3,0))});var i=e.getValue();e.setValue("");eq(t.find(),null);eq(n.find(),null);eq(r.find(),null);e.undo();eqPos(r.find(),Pos(1,5),"still there");e.undo();var s=t.find(),o=n.find();eqPos(s.from,Pos(0,1));eqPos(s.to,Pos(0,3));eqPos(o.from,Pos(0,0));eqPos(o.to,Pos(2,1));eqPos(r.find(),Pos(1,5));e.redo();e.redo();eq(r.find(),null);e.undo();eqPos(r.find(),Pos(1,5));eq(e.getValue(),i)},{value:"1234\n56789\n00\n"});testCM("markTextStayGone",function(e){var t=e.markText(Pos(0,0),Pos(0,1));e.replaceRange("hi",Pos(0,2));t.clear();e.undo();eq(t.find(),null)},{value:"hello"});testCM("markTextAllowEmpty",function(e){var t=e.markText(Pos(0,1),Pos(0,2),{clearWhenEmpty:false});is(t.find());e.replaceRange("x",Pos(0,0));is(t.find());e.replaceRange("y",Pos(0,2));is(t.find());e.replaceRange("z",Pos(0,3),Pos(0,4));is(!t.find());var n=e.markText(Pos(0,1),Pos(0,2),{clearWhenEmpty:false,inclusiveLeft:true,inclusiveRight:true});e.replaceRange("q",Pos(0,1),Pos(0,2));is(n.find());e.replaceRange("",Pos(0,0),Pos(0,3));is(!n.find());var r=e.markText(Pos(0,1),Pos(0,1),{clearWhenEmpty:false});e.replaceRange("a",Pos(0,3));is(r.find());e.replaceRange("b",Pos(0,1));is(!r.find())},{value:"abcde"});testCM("markTextStacked",function(e){var t=e.markText(Pos(0,0),Pos(0,0),{clearWhenEmpty:false});var n=e.markText(Pos(0,0),Pos(0,0),{clearWhenEmpty:false});e.replaceRange("B",Pos(0,1));is(t.find()&&n.find())},{value:"A"});testCM("undoPreservesNewMarks",function(e){e.markText(Pos(0,3),Pos(0,4));e.markText(Pos(1,1),Pos(1,3));e.replaceRange("",Pos(0,3),Pos(3,1));var t=e.markText(Pos(0,0),Pos(0,1));var n=e.markText(Pos(0,5),Pos(0,6));var r=e.markText(Pos(0,2),Pos(0,4));e.undo();eqPos(t.find().from,Pos(0,0));eqPos(t.find().to,Pos(0,1));eqPos(n.find().from,Pos(3,3));eqPos(n.find().to,Pos(3,4));eqPos(r.find().from,Pos(0,2));eqPos(r.find().to,Pos(3,2));var i=e.findMarksAt(Pos(2,2));eq(i.length,1);eq(i[0],r)},{value:"aaaa\nbbbb\ncccc\ndddd"});testCM("markClearBetween",function(e){e.setValue("aaa\nbbb\nccc\nddd\n");e.markText(Pos(0,0),Pos(2));e.replaceRange("aaa\nbbb\nccc",Pos(0,0),Pos(2));eq(e.findMarksAt(Pos(1,1)).length,0)});testCM("deleteSpanCollapsedInclusiveLeft",function(e){var t=Pos(1,0),n=Pos(1,1);var r=e.markText(t,n,{collapsed:true,inclusiveLeft:true});e.replaceRange("",t,n)},{value:"abc\nX\ndef"});testCM("bookmark",function(e){function t(e){return e&&Pos(e[0],e[1])}forEach([{a:[1,0],b:[1,1],c:"",d:[1,4]},{a:[1,1],b:[1,1],c:"xx",d:[1,7]},{a:[1,4],b:[1,5],c:"ab",d:[1,6]},{a:[1,4],b:[1,6],c:"",d:null},{a:[1,5],b:[1,6],c:"abc",d:[1,5]},{a:[1,6],b:[1,8],c:"",d:[1,5]},{a:[1,4],b:[1,4],c:"\n\n",d:[3,1]},{bm:[1,9],a:[1,1],b:[1,1],c:"\n",d:[2,8]}],function(n){e.setValue("1234567890\n1234567890\n1234567890");var r=e.setBookmark(t(n.bm)||Pos(1,5));e.replaceRange(n.c,t(n.a),t(n.b));eqPos(r.find(),t(n.d))})});testCM("bookmarkInsertLeft",function(e){var t=e.setBookmark(Pos(0,2),{insertLeft:false});var n=e.setBookmark(Pos(0,2),{insertLeft:true});e.setCursor(Pos(0,2));e.replaceSelection("hi");eqPos(t.find(),Pos(0,2));eqPos(n.find(),Pos(0,4));e.replaceRange("",Pos(0,4),Pos(0,5));e.replaceRange("",Pos(0,2),Pos(0,4));e.replaceRange("",Pos(0,1),Pos(0,2));eqPos(t.find(),Pos(0,1));eqPos(n.find(),Pos(0,1))},{value:"abcdef"});testCM("bookmarkCursor",function(e){var t=e.cursorCoords(Pos(0,1)),n=e.cursorCoords(Pos(1,1)),r=e.cursorCoords(Pos(2,0)),i=e.cursorCoords(Pos(3,0)),s=e.cursorCoords(Pos(4,1));e.setBookmark(Pos(0,1),{widget:document.createTextNode("←"),insertLeft:true});e.setBookmark(Pos(2,0),{widget:document.createTextNode("←"),insertLeft:true});e.setBookmark(Pos(1,1),{widget:document.createTextNode("→")});e.setBookmark(Pos(3,0),{widget:document.createTextNode("→")});var o=e.cursorCoords(Pos(0,1)),u=e.cursorCoords(Pos(1,1)),a=e.cursorCoords(Pos(2,0)),f=e.cursorCoords(Pos(3,0));near(o.left,t.left,1);near(o.top,t.top,1);is(u.left>n.left,"at right, middle of line");near(u.top==n.top,1);near(a.left,r.left,1);near(a.top,r.top,1);is(f.left>i.left,"at right, empty line");near(f.top,i,1);e.setBookmark(Pos(4,0),{widget:document.createTextNode("→")});is(e.cursorCoords(Pos(4,1)).left>s.left,"single-char bug")},{value:"foo\nbar\n\n\nx\ny"});testCM("multiBookmarkCursor",function(e){function r(n){for(var r=0;r<3;++r){var i=document.createElement("span");i.innerHTML="X";t.push(e.setBookmark(Pos(0,1),{widget:i,insertLeft:n}))}}if(phantom)return;var t=[],n;var i=e.cursorCoords(Pos(0,1)).left,s=e.cursorCoords(Pos(0,4)).left;r(true);near(i,e.cursorCoords(Pos(0,1)).left,1);while(n=t.pop())n.clear();r(false);near(s,e.cursorCoords(Pos(0,1)).left,1)},{value:"abcdefg"});testCM("getAllMarks",function(e){addDoc(e,10,10);var t=e.setBookmark(Pos(0,2));var n=e.markText(Pos(0,2),Pos(3,2));var r=e.markText(Pos(1,2),Pos(1,8));var i=e.markText(Pos(8,0),Pos(9,0));eq(e.getAllMarks().length,4);t.clear();r.clear();eq(e.getAllMarks().length,2)});testCM("bug577",function(e){e.setValue("a\nb");e.clearHistory();e.setValue("fooooo");e.undo()});testCM("scrollSnap",function(e){e.setSize(100,100);addDoc(e,200,200);e.setCursor(Pos(100,180));var t=e.getScrollInfo();is(t.left>0&&t.top>0);e.setCursor(Pos(0,0));t=e.getScrollInfo();is(t.left==0&&t.top==0,"scrolled clean to top");e.setCursor(Pos(100,180));e.setCursor(Pos(199,0));t=e.getScrollInfo();is(t.left==0&&t.top+2>t.height-e.getScrollerElement().clientHeight,"scrolled clean to bottom")});testCM("scrollIntoView",function(e){function n(n,r,i){var s=Pos(n,r);e.scrollIntoView(s);var o=e.charCoords(s,"window");is(o.left>=t.left,i+" (left)");is(o.right<=t.right,i+" (right)");is(o.top>=t.top,i+" (top)");is(o.bottom<=t.bottom,i+" (bottom)")}if(phantom)return;var t=e.getWrapperElement().getBoundingClientRect();addDoc(e,200,200);n(199,199,"bottom right");n(0,0,"top left");n(100,100,"center");n(199,0,"bottom left");n(0,199,"top right");n(100,100,"center again")});testCM("scrollBackAndForth",function(e){addDoc(e,1,200);e.operation(function(){e.scrollIntoView(Pos(199,0));e.scrollIntoView(Pos(4,0))});is(e.getScrollInfo().top>0)});testCM("selectAllNoScroll",function(e){addDoc(e,1,200);e.execCommand("selectAll");eq(e.getScrollInfo().top,0);e.setCursor(199);e.execCommand("selectAll");is(e.getScrollInfo().top>0)});testCM("selectionPos",function(e){if(phantom)return;e.setSize(100,100);addDoc(e,200,100);e.setSelection(Pos(1,100),Pos(98,100));var t=e.charCoords(Pos(0,200),"local").left;var n=(e.charCoords(Pos(99)).top-e.charCoords(Pos(0)).top)/100;e.scrollTo(0,0);var r=byClassName(e.getWrapperElement(),"CodeMirror-selected");var i=e.getWrapperElement().getBoundingClientRect();var s,o,u;for(var a=0,f=r.length;a<f;++a){var l=r[a].getBoundingClientRect();var c=l.left-i.left<30;var h=l.right-l.left;var p=l.right-i.left>.8*t;if(c&&p){s=true;is(l.bottom-l.top>90*n,"middle high");is(h>.9*t,"middle wide")}else{is(h>.4*t,"top/bot wide enough");is(h<.6*t,"top/bot slim enough");if(c){u=true;is(l.top-i.top>96*n,"bot below")}else if(p){o=true;is(l.top-i.top<2.1*n,"top above")}}}is(o&&u&&s,"all parts")},null);testCM("restoreHistory",function(e){e.setValue("abc\ndef");e.replaceRange("hello",Pos(1,0),Pos(1));e.replaceRange("goop",Pos(0,0),Pos(0));e.undo();var t=e.getValue(),n=e.getHistory();if(window.JSON)n=JSON.parse(JSON.stringify(n));eq(t,"abc\nhello");e.setValue("");e.clearHistory();eq(e.historySize().undo,0);e.setValue(t);e.setHistory(n);e.redo();eq(e.getValue(),"goop\nhello");e.undo();e.undo();eq(e.getValue(),"abc\ndef")});testCM("doubleScrollbar",function(e){var t=document.body.appendChild(document.createElement("p"));t.style.cssText="height: 50px; overflow: scroll; width: 50px";var n=t.offsetWidth+1-t.clientWidth;document.body.removeChild(t);if(n<2)return;e.setSize(null,100);addDoc(e,1,300);var r=e.getWrapperElement();is(r.offsetWidth-byClassName(r,"CodeMirror-lines")[0].offsetWidth<=n*1.5)});testCM("weirdLinebreaks",function(e){e.setValue("foo\nbar\rbaz\r\nquux\n\rplop");is(e.getValue(),"foo\nbar\nbaz\nquux\n\nplop");is(e.lineCount(),6);e.setValue("\n\n");is(e.lineCount(),3)});testCM("setSize",function(e){e.setSize(100,100);var t=e.getWrapperElement();is(t.offsetWidth,100);is(t.offsetHeight,100);e.setSize("100%","3em");is(t.style.width,"100%");is(t.style.height,"3em");e.setSize(null,40);is(t.style.width,"100%");is(t.style.height,"40px")});testCM("collapsedLines",function(e){addDoc(e,4,10);var t=foldLines(e,4,5),n=0;CodeMirror.on(t,"clear",function(){n++});e.setCursor(Pos(3,0));CodeMirror.commands.goLineDown(e);eqPos(e.getCursor(),Pos(5,0));e.replaceRange("abcdefg",Pos(3,0),Pos(3));e.setCursor(Pos(3,6));CodeMirror.commands.goLineDown(e);eqPos(e.getCursor(),Pos(5,4));e.replaceRange("ab",Pos(3,0),Pos(3));e.setCursor(Pos(3,2));CodeMirror.commands.goLineDown(e);eqPos(e.getCursor(),Pos(5,2));e.operation(function(){t.clear();t.clear()});eq(n,1)});testCM("collapsedRangeCoordsChar",function(e){var t=e.charCoords(Pos(1,3));t.left+=2;t.top+=2;var n={collapsed:true,inclusiveLeft:true,inclusiveRight:true};var r=e.markText(Pos(0,0),Pos(2,0),n);eqPos(e.coordsChar(t),Pos(3,3));r.clear();var r=e.markText(Pos(0,0),Pos(1,1),{collapsed:true,inclusiveLeft:true});var i=e.markText(Pos(1,1),Pos(2,0),{collapsed:true,inclusiveRight:true});eqPos(e.coordsChar(t),Pos(3,3));r.clear();i.clear();var r=e.markText(Pos(0,0),Pos(1,6),n);eqPos(e.coordsChar(t),Pos(3,3))},{value:"123456\nabcdef\nghijkl\nmnopqr\n"});testCM("collapsedRangeBetweenLinesSelected",function(e){var t=document.createElement("span");t.textContent="↔";e.markText(Pos(0,3),Pos(1,0),{replacedWith:t});e.setSelection(Pos(0,3),Pos(1,0));var n=byClassName(e.getWrapperElement(),"CodeMirror-selected");for(var r=0,i=0;r<n.length;r++)i+=n[r].offsetWidth;is(i>0)},{value:"one\ntwo"});testCM("randomCollapsedRanges",function(e){addDoc(e,20,500);e.operation(function(){for(var t=0;t<200;t++){var n=Pos(Math.floor(Math.random()*500),Math.floor(Math.random()*20));if(t%4)try{e.markText(n,Pos(n.line+2,1),{collapsed:true})}catch(r){if(!/overlapping/.test(String(r)))throw r}else e.markText(n,Pos(n.line,n.ch+4),{className:"foo"})}})});testCM("hiddenLinesAutoUnfold",function(e){var t=foldLines(e,1,3,true),n=0;CodeMirror.on(t,"clear",function(){n++});e.setCursor(Pos(3,0));eq(n,0);e.execCommand("goCharLeft");eq(n,1);t=foldLines(e,1,3,true);CodeMirror.on(t,"clear",function(){n++});eqPos(e.getCursor(),Pos(3,0));e.setCursor(Pos(0,3));e.execCommand("goCharRight");eq(n,2)},{value:"abc\ndef\nghi\njkl"});testCM("hiddenLinesSelectAll",function(e){addDoc(e,4,20);foldLines(e,0,10);foldLines(e,11,20);CodeMirror.commands.selectAll(e);eqPos(e.getCursor(true),Pos(10,0));eqPos(e.getCursor(false),Pos(10,4))});testCM("everythingFolded",function(e){function t(){e.triggerOnKeyDown({type:"keydown",keyCode:13,preventDefault:function(){},stopPropagation:function(){}})}addDoc(e,2,2);var n=foldLines(e,0,2);t();eq(e.getValue(),"xx\nxx");n.clear();n=foldLines(e,0,2,true);eq(n.find(),null);t();eq(e.getValue(),"\nxx\nxx")});testCM("structuredFold",function(e){if(phantom)return;addDoc(e,4,8);var t=e.markText(Pos(1,2),Pos(6,2),{replacedWith:document.createTextNode("Q")});e.setCursor(0,3);CodeMirror.commands.goLineDown(e);eqPos(e.getCursor(),Pos(6,2));CodeMirror.commands.goCharLeft(e);eqPos(e.getCursor(),Pos(1,2));CodeMirror.commands.delCharAfter(e);eq(e.getValue(),"xxxx\nxxxx\nxxxx");addDoc(e,4,8);t=e.markText(Pos(1,2),Pos(6,2),{replacedWith:document.createTextNode("M"),clearOnEnter:true});var n=0;CodeMirror.on(t,"clear",function(){++n});e.setCursor(0,3);CodeMirror.commands.goLineDown(e);eqPos(e.getCursor(),Pos(6,2));CodeMirror.commands.goCharLeft(e);eqPos(e.getCursor(),Pos(6,1));eq(n,1);t.clear();eq(n,1);t=e.markText(Pos(1,2),Pos(6,2),{replacedWith:document.createTextNode("Q"),clearOnEnter:true});t.clear();e.setCursor(1,2);CodeMirror.commands.goCharRight(e);eqPos(e.getCursor(),Pos(1,3));t=e.markText(Pos(2,0),Pos(4,4),{replacedWith:document.createTextNode("M")});e.setCursor(1,0);CodeMirror.commands.goLineDown(e);eqPos(e.getCursor(),Pos(2,0))},null);testCM("nestedFold",function(e){function t(t,n,r,i){return e.markText(Pos(t,n),Pos(r,i),{collapsed:true})}addDoc(e,10,3);var n=t(0,6,1,3),r=t(0,2,1,8),i=t(0,1,2,3),s=t(0,5,0,6);e.setCursor(0,1);CodeMirror.commands.goCharRight(e);eqPos(e.getCursor(),Pos(2,3));s.clear();CodeMirror.commands.goCharLeft(e);eqPos(e.getCursor(),Pos(0,1));i.clear();CodeMirror.commands.goCharRight(e);eqPos(e.getCursor(),Pos(0,2));CodeMirror.commands.goCharRight(e);eqPos(e.getCursor(),Pos(1,8));r.clear();CodeMirror.commands.goCharLeft(e);eqPos(e.getCursor(),Pos(1,7));e.setCursor(0,5);CodeMirror.commands.goCharRight(e);eqPos(e.getCursor(),Pos(0,6));CodeMirror.commands.goCharRight(e);eqPos(e.getCursor(),Pos(1,3))});testCM("badNestedFold",function(e){addDoc(e,4,4);e.markText(Pos(0,2),Pos(3,2),{collapsed:true});var t;try{e.markText(Pos(0,1),Pos(0,3),{collapsed:true})}catch(n){t=n}is(t instanceof Error,"no error");is(/overlap/i.test(t.message),"wrong error")});testCM("nestedFoldOnSide",function(e){var t=e.markText(Pos(0,1),Pos(2,1),{collapsed:true,inclusiveRight:true});var n=e.markText(Pos(0,1),Pos(0,2),{collapsed:true});e.markText(Pos(0,1),Pos(0,2),{collapsed:true}).clear();try{e.markText(Pos(0,1),Pos(0,2),{collapsed:true,inclusiveLeft:true})}catch(r){var i=r}is(i&&/overlap/i.test(i.message));var s=e.markText(Pos(2,0),Pos(2,1),{collapsed:true});var o=e.markText(Pos(2,0),Pos(2,1),{collapse:true,inclusiveRight:true});t.clear();o.clear();t=e.markText(Pos(0,1),Pos(2,1),{collapsed:true});e.markText(Pos(2,0),Pos(2,1),{collapsed:true}).clear();try{e.markText(Pos(2,0),Pos(2,1),{collapsed:true,inclusiveRight:true})}catch(r){var i=r}is(i&&/overlap/i.test(i.message))},{value:"ab\ncdef"});testCM("editInFold",function(e){addDoc(e,4,6);var t=e.markText(Pos(1,2),Pos(3,2),{collapsed:true});e.replaceRange("",Pos(0,0),Pos(1,3));e.replaceRange("",Pos(2,1),Pos(3,3));e.replaceRange("a\nb\nc\nd",Pos(0,1),Pos(1,0));e.cursorCoords(Pos(0,0))});testCM("wrappingInlineWidget",function(e){e.setSize("11em");var t=document.createElement("span");t.style.color="red";t.innerHTML="one two three four";e.markText(Pos(0,6),Pos(0,9),{replacedWith:t});var n=e.cursorCoords(Pos(0,0)),r=e.cursorCoords(Pos(0,10));is(n.top<r.top);is(n.bottom<r.bottom);var i=e.cursorCoords(Pos(0,6)),s=e.cursorCoords(Pos(0,9));eq(i.top,n.top);eq(i.bottom,n.bottom);eq(s.top,r.top);eq(s.bottom,r.bottom);e.replaceRange("",Pos(0,9),Pos(0));s=e.cursorCoords(Pos(0,9));if(phantom)return;eq(s.top,r.top);eq(s.bottom,r.bottom)},{value:"1 2 3 xxx 4",lineWrapping:true});testCM("changedInlineWidget",function(e){e.setSize("10em");var t=document.createElement("span");t.innerHTML="x";var n=e.markText(Pos(0,4),Pos(0,5),{replacedWith:t});t.innerHTML="and now the widget is really really long all of a sudden and a scrollbar is needed";n.changed();var r=byClassName(e.getWrapperElement(),"CodeMirror-hscrollbar")[0];is(r.scrollWidth>r.clientWidth)},{value:"hello there"});testCM("changedBookmark",function(e){e.setSize("10em");var t=document.createElement("span");t.innerHTML="x";var n=e.setBookmark(Pos(0,4),{widget:t});t.innerHTML="and now the widget is really really long all of a sudden and a scrollbar is needed";n.changed();var r=byClassName(e.getWrapperElement(),"CodeMirror-hscrollbar")[0];is(r.scrollWidth>r.clientWidth)},{value:"abcdefg"});testCM("inlineWidget",function(e){var t=e.setBookmark(Pos(0,2),{widget:document.createTextNode("uu")});e.setCursor(0,2);CodeMirror.commands.goLineDown(e);eqPos(e.getCursor(),Pos(1,4));e.setCursor(0,2);e.replaceSelection("hi");eqPos(t.find(),Pos(0,2));e.setCursor(0,1);e.replaceSelection("ay");eqPos(t.find(),Pos(0,4));eq(e.getLine(0),"uayuhiuu")},{value:"uuuu\nuuuuuu"});testCM("wrappingAndResizing",function(e){e.setSize(null,"auto");e.setOption("lineWrapping",true);var t=e.getWrapperElement(),n=t.offsetHeight;var r="xxx xxx xxx xxx xxx";e.setValue(r);for(var i=10,s=e.charCoords(Pos(0,18),"div").right;;s+=i){e.setSize(s);if(t.offsetHeight<=n*(opera_lt10?1.2:1.5)){if(i==10){s-=10;i=1}else break}}e.setCursor(Pos(0,r.length));eq(t.offsetHeight,n);e.replaceSelection("x");is(t.offsetHeight>n,"wrapping happens");e.setValue(r+"\n"+r+"\n");e.getScrollerElement().style.maxHeight="100px";e.replaceRange("\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n!\n",Pos(2,0));forEach([Pos(0,r.length),Pos(0,r.length-1),Pos(0,0),Pos(1,r.length),Pos(1,r.length-1)],function(t){var n=e.charCoords(t);eqPos(t,e.coordsChar({left:n.left+2,top:n.top+5}))})},null,ie_lt8);testCM("measureEndOfLine",function(e){e.setSize(null,"auto");var t=byClassName(e.getWrapperElement(),"CodeMirror-lines")[0].firstChild;var n=t.offsetHeight;for(var r=10,i=e.charCoords(Pos(0,7),"div").right;;i+=r){e.setSize(i);if(t.offsetHeight<2.5*n){if(r==10){i-=10;r=1}else break}}e.setValue(e.getValue()+"\n\n");var s=e.charCoords(Pos(0,18),"local");is(s.top>n*.8,"not at top");is(s.left>i-20,"not at right");s=e.charCoords(Pos(0,18));eqPos(e.coordsChar({left:s.left,top:s.top+5}),Pos(0,18))},{mode:"text/html",value:"<!-- foo barrr -->",lineWrapping:true},ie_lt8||opera_lt10);testCM("scrollVerticallyAndHorizontally",function(e){e.setSize(100,100);addDoc(e,40,40);e.setCursor(39);var t=e.getWrapperElement(),n=byClassName(t,"CodeMirror-vscrollbar")[0];is(n.offsetHeight<t.offsetHeight,"vertical scrollbar limited by horizontal one");var r=byClassName(t,"CodeMirror-cursor")[0].getBoundingClientRect();var i=t.getBoundingClientRect();is(r.bottom<i.top+e.getScrollerElement().clientHeight,"bottom line visible")},{lineNumbers:true});testCM("moveVstuck",function(e){var t=byClassName(e.getWrapperElement(),"CodeMirror-lines")[0].firstChild,n=t.offsetHeight;var r="fooooooooooooooooooooooooo baaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaar\n";e.setValue(r);for(var i=e.charCoords(Pos(0,26),"div").right*2.8;;i+=5){e.setSize(i);if(t.offsetHeight<=3.5*n)break}e.setCursor(Pos(0,r.length-1));e.moveV(-1,"line");eqPos(e.getCursor(),Pos(0,26))},{lineWrapping:true},ie_lt8||opera_lt10);testCM("collapseOnMove",function(e){e.setSelection(Pos(0,1),Pos(2,4));e.execCommand("goLineUp");is(!e.somethingSelected());eqPos(e.getCursor(),Pos(0,1));e.setSelection(Pos(0,1),Pos(2,4));e.execCommand("goPageDown");is(!e.somethingSelected());eqPos(e.getCursor(),Pos(2,4));e.execCommand("goLineUp");e.execCommand("goLineUp");eqPos(e.getCursor(),Pos(0,4));e.setSelection(Pos(0,1),Pos(2,4));e.execCommand("goCharLeft");is(!e.somethingSelected());eqPos(e.getCursor(),Pos(0,1))},{value:"aaaaa\nb\nccccc"});testCM("clickTab",function(e){var t=e.charCoords(Pos(0,0));eqPos(e.coordsChar({left:t.left+5,top:t.top+5}),Pos(0,0));eqPos(e.coordsChar({left:t.right-5,top:t.top+5}),Pos(0,1))},{value:"	\n\n",lineWrapping:true,tabSize:8});testCM("verticalScroll",function(e){e.setSize(100,200);e.setValue("foo\nbar\nbaz\n");var t=e.getScrollerElement(),n=t.scrollWidth;e.replaceRange("aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaah",Pos(0,0),Pos(0));is(t.scrollWidth>n,"scrollbar present");e.replaceRange("foo",Pos(0,0),Pos(0));if(!phantom)eq(t.scrollWidth,n,"scrollbar gone");e.replaceRange("aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaah",Pos(0,0),Pos(0));e.replaceRange("bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbh",Pos(1,0),Pos(1));is(t.scrollWidth>n,"present again");var r=t.scrollWidth;e.replaceRange("foo",Pos(0,0),Pos(0));is(t.scrollWidth<r,"scrollbar smaller");is(t.scrollWidth>n,"but still present")});testCM("extraKeys",function(e){function n(n,r,i){if(typeof r=="string")r=r.charCodeAt(0);var s={type:"keydown",keyCode:r,preventDefault:function(){},stopPropagation:function(){}};if(i)for(var o in i)s[o]=i[o];t=null;e.triggerOnKeyDown(s);eq(t,n)}var t;CodeMirror.commands.testCommand=function(){t="tc"};CodeMirror.commands.goTestCommand=function(){t="gtc"};e.setOption("extraKeys",{"Shift-X":function(){t="sx"},X:function(){t="x"},"Ctrl-Alt-U":function(){t="cau"},End:"testCommand",Home:"goTestCommand",Tab:false});n(null,"U");n("cau","U",{ctrlKey:true,altKey:true});n(null,"U",{shiftKey:true,ctrlKey:true,altKey:true});n("x","X");n("sx","X",{shiftKey:true});n("tc",35);n(null,35,{shiftKey:true});n("gtc",36);n("gtc",36,{shiftKey:true});n(null,9)},null,window.opera&&mac);testCM("wordMovementCommands",function(e){e.execCommand("goWordLeft");eqPos(e.getCursor(),Pos(0,0));e.execCommand("goWordRight");e.execCommand("goWordRight");eqPos(e.getCursor(),Pos(0,7));e.execCommand("goWordLeft");eqPos(e.getCursor(),Pos(0,5));e.execCommand("goWordRight");e.execCommand("goWordRight");eqPos(e.getCursor(),Pos(0,12));e.execCommand("goWordLeft");eqPos(e.getCursor(),Pos(0,9));e.execCommand("goWordRight");e.execCommand("goWordRight");e.execCommand("goWordRight");eqPos(e.getCursor(),Pos(0,24));e.execCommand("goWordRight");e.execCommand("goWordRight");eqPos(e.getCursor(),Pos(1,9));e.execCommand("goWordRight");eqPos(e.getCursor(),Pos(1,13));e.execCommand("goWordRight");e.execCommand("goWordRight");eqPos(e.getCursor(),Pos(2,0))},{value:"this is (the) firstline.\na foo12éø×bar\n"});testCM("groupMovementCommands",function(e){e.execCommand("goGroupLeft");eqPos(e.getCursor(),Pos(0,0));e.execCommand("goGroupRight");eqPos(e.getCursor(),Pos(0,4));e.execCommand("goGroupRight");eqPos(e.getCursor(),Pos(0,7));e.execCommand("goGroupRight");eqPos(e.getCursor(),Pos(0,10));e.execCommand("goGroupLeft");eqPos(e.getCursor(),Pos(0,7));e.execCommand("goGroupRight");e.execCommand("goGroupRight");e.execCommand("goGroupRight");eqPos(e.getCursor(),Pos(0,15));e.setCursor(Pos(0,17));e.execCommand("goGroupLeft");eqPos(e.getCursor(),Pos(0,16));e.execCommand("goGroupLeft");eqPos(e.getCursor(),Pos(0,14));e.execCommand("goGroupRight");e.execCommand("goGroupRight");eqPos(e.getCursor(),Pos(0,20));e.execCommand("goGroupRight");eqPos(e.getCursor(),Pos(1,0));e.execCommand("goGroupRight");eqPos(e.getCursor(),Pos(1,2));e.execCommand("goGroupRight");eqPos(e.getCursor(),Pos(1,5));e.execCommand("goGroupLeft");e.execCommand("goGroupLeft");eqPos(e.getCursor(),Pos(1,0));e.execCommand("goGroupLeft");eqPos(e.getCursor(),Pos(0,20));e.execCommand("goGroupLeft");eqPos(e.getCursor(),Pos(0,16))},{value:"booo ba---quux. ffff\n  abc d"});testCM("groupsAndWhitespace",function(e){var t=[Pos(0,0),Pos(0,2),Pos(0,5),Pos(0,9),Pos(0,11),Pos(1,0),Pos(1,2),Pos(1,5)];for(var n=1;n<t.length;n++){e.execCommand("goGroupRight");eqPos(e.getCursor(),t[n])}for(var n=t.length-2;n>=0;n--){e.execCommand("goGroupLeft");eqPos(e.getCursor(),n==2?Pos(0,6):t[n])}},{value:"  foo +++  \n  bar"});testCM("charMovementCommands",function(e){e.execCommand("goCharLeft");e.execCommand("goColumnLeft");eqPos(e.getCursor(),Pos(0,0));e.execCommand("goCharRight");e.execCommand("goCharRight");eqPos(e.getCursor(),Pos(0,2));e.setCursor(Pos(1,0));e.execCommand("goColumnLeft");eqPos(e.getCursor(),Pos(1,0));e.execCommand("goCharLeft");eqPos(e.getCursor(),Pos(0,5));e.execCommand("goColumnRight");eqPos(e.getCursor(),Pos(0,5));e.execCommand("goCharRight");eqPos(e.getCursor(),Pos(1,0));e.execCommand("goLineEnd");eqPos(e.getCursor(),Pos(1,5));e.execCommand("goLineStartSmart");eqPos(e.getCursor(),Pos(1,1));e.execCommand("goLineStartSmart");eqPos(e.getCursor(),Pos(1,0));e.setCursor(Pos(2,0));e.execCommand("goCharRight");e.execCommand("goColumnRight");eqPos(e.getCursor(),Pos(2,0))},{value:"line1\n ine2\n"});testCM("verticalMovementCommands",function(e){e.execCommand("goLineUp");eqPos(e.getCursor(),Pos(0,0));e.execCommand("goLineDown");if(!phantom)eqPos(e.getCursor(),Pos(1,0));e.setCursor(Pos(1,12));e.execCommand("goLineDown");eqPos(e.getCursor(),Pos(2,5));e.execCommand("goLineDown");eqPos(e.getCursor(),Pos(3,0));e.execCommand("goLineUp");eqPos(e.getCursor(),Pos(2,5));e.execCommand("goLineUp");eqPos(e.getCursor(),Pos(1,12));e.execCommand("goPageDown");eqPos(e.getCursor(),Pos(5,0));e.execCommand("goPageDown");e.execCommand("goLineDown");eqPos(e.getCursor(),Pos(5,0));e.execCommand("goPageUp");eqPos(e.getCursor(),Pos(0,0))},{value:"line1\nlong long line2\nline3\n\nline5\n"});testCM("verticalMovementCommandsWrapping",function(e){e.setSize(120);e.setCursor(Pos(0,5));e.execCommand("goLineDown");eq(e.getCursor().line,0);is(e.getCursor().ch>5,"moved beyond wrap");for(var t=0;;++t){is(t<20,"no endless loop");e.execCommand("goLineDown");var n=e.getCursor();if(n.line==1)eq(n.ch,5);if(n.line==2){eq(n.ch,1);break}}},{value:"a very long line that wraps around somehow so that we can test cursor movement\nshortone\nk",lineWrapping:true});testCM("rtlMovement",function(e){forEach(["خحج","خحabcخحج","abخحخحجcd","abخde","abخح2342خ1حج","خ1ح2خح3حxج","خحcd","1خحcd","abcdeح1ج","خمرحبها مها!","foobarر","خ ة ق",'<img src="/בדיקה3.jpg">'],function(t){var n=t.charAt(0)=="خ";e.setValue(t+"\n");e.execCommand(n?"goLineEnd":"goLineStart");var r=byClassName(e.getWrapperElement(),"CodeMirror-cursors")[0];var i=r.firstChild;var s=i.offsetLeft,o=i.offsetTop;for(var u=0;u<=t.length;++u){e.execCommand("goCharRight");i=r.firstChild;if(u==t.length)is(i.offsetTop>o,"next line");else is(i.offsetLeft>s,"moved right");s=i.offsetLeft;o=i.offsetTop}e.setCursor(0,0);e.execCommand(n?"goLineStart":"goLineEnd");s=r.firstChild.offsetLeft;for(var u=0;u<t.length;++u){e.execCommand("goCharLeft");i=r.firstChild;is(i.offsetLeft<s,"moved left");s=i.offsetLeft}})},null,ie_lt9);testCM("bidiUpdate",function(e){e.setCursor(Pos(0,2));e.replaceSelection("خحج","start");e.execCommand("goCharRight");eqPos(e.getCursor(),Pos(0,4))},{value:"abcd\n"});testCM("movebyTextUnit",function(e){e.setValue("בְּרֵאשִ\nééé́\n");e.execCommand("goLineEnd");for(var t=0;t<4;++t)e.execCommand("goCharRight");eqPos(e.getCursor(),Pos(0,0));e.execCommand("goCharRight");eqPos(e.getCursor(),Pos(1,0));e.execCommand("goCharRight");e.execCommand("goCharRight");eqPos(e.getCursor(),Pos(1,4));e.execCommand("goCharRight");eqPos(e.getCursor(),Pos(1,7))});testCM("lineChangeEvents",function(e){addDoc(e,3,5);var t=[],n=["ch 0","ch 1","del 2","ch 0","ch 0","del 1","del 3","del 4"];for(var r=0;r<5;++r){CodeMirror.on(e.getLineHandle(r),"delete",function(e){return function(){t.push("del "+e)}}(r));CodeMirror.on(e.getLineHandle(r),"change",function(e){return function(){t.push("ch "+e)}}(r))}e.replaceRange("x",Pos(0,1));e.replaceRange("xy",Pos(1,1),Pos(2));e.replaceRange("foo\nbar",Pos(0,1));e.replaceRange("",Pos(0,0),Pos(e.lineCount()));eq(t.length,n.length,"same length");for(var r=0;r<t.length;++r)eq(t[r],n[r])});testCM("scrollEntirelyToRight",function(e){if(phantom)return;addDoc(e,500,2);e.setCursor(Pos(0,500));var t=e.getWrapperElement(),n=byClassName(t,"CodeMirror-cursor")[0];is(t.getBoundingClientRect().right>n.getBoundingClientRect().left)});testCM("lineWidgets",function(e){addDoc(e,500,3);var t=e.charCoords(Pos(2,0));var n=document.createElement("div");n.innerHTML="hi";var r=e.addLineWidget(1,n);is(t.top<e.charCoords(Pos(2,0)).top,"took up space");e.setCursor(Pos(1,1));e.execCommand("goLineDown");eqPos(e.getCursor(),Pos(2,1));e.execCommand("goLineUp");eqPos(e.getCursor(),Pos(1,1))});testCM("lineWidgetFocus",function(e){var t=document.getElementById("testground");t.className="offscreen";try{addDoc(e,500,10);var n=document.createElement("input");var r=e.addLineWidget(1,n);n.focus();eq(document.activeElement,n);e.replaceRange("new stuff",Pos(1,0));eq(document.activeElement,n)}finally{t.className=""}});testCM("lineWidgetCautiousRedraw",function(e){var t=document.createElement("div");t.innerHTML="hahah";var n=e.addLineWidget(0,t);var r=false;n.on("redraw",function(){r=true});e.replaceSelection("0");is(!r)},{value:"123\n456"});testCM("lineWidgetChanged",function(e){function t(){var e=document.createElement("div");e.style.cssText="background: yellow; height: 50px;";return e}addDoc(e,2,300);e.setSize(null,e.defaultTextHeight()*50);e.scrollTo(null,e.heightAtLine(125,"local"));var n=e.getScrollInfo();var r=e.addLineWidget(0,t());var i=e.addLineWidget(150,t());var s=e.addLineWidget(300,t());var o=e.getScrollInfo();eq(n.height+150,o.height);eq(n.top+50,o.top);r.node.style.height=i.node.style.height=s.node.style.height="10px";r.changed();i.changed();s.changed();var u=e.getScrollInfo();eq(n.height+30,u.height);eq(n.top+10,u.top)});testCM("getLineNumber",function(e){addDoc(e,2,20);var t=e.getLineHandle(1);eq(e.getLineNumber(t),1);e.replaceRange("hi\nbye\n",Pos(0,0));eq(e.getLineNumber(t),3);e.setValue("");eq(e.getLineNumber(t),null)});testCM("jumpTheGap",function(e){if(phantom)return;var t="abcdef ghiklmnop qrstuvw xyz ";t+=t;t+=t;t+=t;e.replaceRange(t,Pos(2,0),Pos(2));e.setSize("200px",null);e.getWrapperElement().style.lineHeight=2;e.refresh();e.setCursor(Pos(0,1));e.execCommand("goLineDown");eqPos(e.getCursor(),Pos(1,1));e.execCommand("goLineDown");eqPos(e.getCursor(),Pos(2,1));e.execCommand("goLineDown");eq(e.getCursor().line,2);is(e.getCursor().ch>1);e.execCommand("goLineUp");eqPos(e.getCursor(),Pos(2,1));e.execCommand("goLineUp");eqPos(e.getCursor(),Pos(1,1));var n=document.createElement("div");n.innerHTML="hi";n.style.height="30px";e.addLineWidget(0,n);e.addLineWidget(1,n.cloneNode(true),{above:true});e.setCursor(Pos(0,2));e.execCommand("goLineDown");eqPos(e.getCursor(),Pos(1,2));e.execCommand("goLineUp");eqPos(e.getCursor(),Pos(0,2))},{lineWrapping:true,value:"abc\ndef\nghi\njkl\n"});testCM("addLineClass",function(e){function t(t,n,r,i){var s=e.lineInfo(t);eq(s.textClass,n);eq(s.bgClass,r);eq(s.wrapClass,i)}e.addLineClass(0,"text","foo");e.addLineClass(0,"text","bar");e.addLineClass(1,"background","baz");e.addLineClass(1,"wrap","foo");t(0,"foo bar",null,null);t(1,null,"baz","foo");var n=e.display.lineDiv;eq(byClassName(n,"foo").length,2);eq(byClassName(n,"bar").length,1);eq(byClassName(n,"baz").length,1);e.removeLineClass(0,"text","foo");t(0,"bar",null,null);e.removeLineClass(0,"text","foo");t(0,"bar",null,null);e.removeLineClass(0,"text","bar");t(0,null,null,null);e.addLineClass(1,"wrap","quux");t(1,null,"baz","foo quux");e.removeLineClass(1,"wrap");t(1,null,"baz",null)},{value:"hohoho\n"});testCM("atomicMarker",function(e){function t(t,n,r,i,s,o){return e.markText(Pos(t,n),Pos(r,i),{atomic:true,inclusiveLeft:s,inclusiveRight:o})}addDoc(e,10,10);var n=t(0,1,0,5);e.setCursor(Pos(0,1));e.execCommand("goCharRight");eqPos(e.getCursor(),Pos(0,5));e.execCommand("goCharLeft");eqPos(e.getCursor(),Pos(0,1));n.clear();n=t(0,0,0,5,true);eqPos(e.getCursor(),Pos(0,5),"pushed out");e.execCommand("goCharLeft");eqPos(e.getCursor(),Pos(0,5));n.clear();n=t(8,4,9,10,false,true);e.setCursor(Pos(9,8));eqPos(e.getCursor(),Pos(8,4),"set");e.execCommand("goCharRight");eqPos(e.getCursor(),Pos(8,4),"char right");e.execCommand("goLineDown");eqPos(e.getCursor(),Pos(8,4),"line down");e.execCommand("goCharLeft");eqPos(e.getCursor(),Pos(8,3));n.clear();n=t(1,1,3,8);e.setCursor(Pos(0,0));e.setCursor(Pos(2,0));eqPos(e.getCursor(),Pos(3,8));e.execCommand("goCharLeft");eqPos(e.getCursor(),Pos(1,1));e.execCommand("goCharRight");eqPos(e.getCursor(),Pos(3,8));e.execCommand("goLineUp");eqPos(e.getCursor(),Pos(1,1));e.execCommand("goLineDown");eqPos(e.getCursor(),Pos(3,8));e.execCommand("delCharBefore");eq(e.getValue().length,80,"del chunk");n=t(3,0,5,5);e.setCursor(Pos(3,0));e.execCommand("delWordAfter");eq(e.getValue().length,53,"del chunk")});testCM("readOnlyMarker",function(e){function t(t,n,r,i,s){return e.markText(Pos(t,n),Pos(r,i),{readOnly:true,atomic:s})}var n=t(0,1,0,4);e.setCursor(Pos(0,2));e.replaceSelection("hi","end");eqPos(e.getCursor(),Pos(0,2));eq(e.getLine(0),"abcde");e.execCommand("selectAll");e.replaceSelection("oops","around");eq(e.getValue(),"oopsbcd");e.undo();eqPos(n.find().from,Pos(0,1));eqPos(n.find().to,Pos(0,4));n.clear();e.setCursor(Pos(0,2));e.replaceSelection("hi","around");eq(e.getLine(0),"abhicde");eqPos(e.getCursor(),Pos(0,4));n=t(0,2,2,2,true);e.setSelection(Pos(1,1),Pos(2,4));e.replaceSelection("t","end");eqPos(e.getCursor(),Pos(2,3));eq(e.getLine(2),"klto");e.execCommand("goCharLeft");e.execCommand("goCharLeft");eqPos(e.getCursor(),Pos(0,2));e.setSelection(Pos(0,1),Pos(0,3));e.replaceSelection("xx","around");eqPos(e.getCursor(),Pos(0,3));eq(e.getLine(0),"axxhicde")},{value:"abcde\nfghij\nklmno\n"});testCM("dirtyBit",function(e){eq(e.isClean(),true);e.replaceSelection("boo",null,"test");eq(e.isClean(),false);e.undo();eq(e.isClean(),true);e.replaceSelection("boo",null,"test");e.replaceSelection("baz",null,"test");e.undo();eq(e.isClean(),false);e.markClean();eq(e.isClean(),true);e.undo();eq(e.isClean(),false);e.redo();eq(e.isClean(),true)});testCM("changeGeneration",function(e){e.replaceSelection("x");var t=e.changeGeneration();e.replaceSelection("x");e.undo();eq(e.getValue(),"");is(!e.isClean(t));e.replaceSelection("x");var n=e.changeGeneration(true);e.replaceSelection("x");e.undo();eq(e.getValue(),"x");is(e.isClean(n))});testCM("addKeyMap",function(e){function t(t){e.triggerOnKeyDown({type:"keydown",keyCode:t,preventDefault:function(){},stopPropagation:function(){}})}t(39);eqPos(e.getCursor(),Pos(0,1));var n=0;var r={Right:function(){++n}},i={Right:function(){n+=10}};e.addKeyMap(r);t(39);eqPos(e.getCursor(),Pos(0,1));eq(n,1);e.addKeyMap(i,true);t(39);eq(n,2);e.removeKeyMap(r);t(39);eq(n,12);e.removeKeyMap(i);t(39);eq(n,12);eqPos(e.getCursor(),Pos(0,2));e.addKeyMap({Right:function(){n=55},name:"mymap"});t(39);eq(n,55);e.removeKeyMap("mymap");t(39);eqPos(e.getCursor(),Pos(0,3))},{value:"abc"});testCM("findPosH",function(e){forEach([{from:Pos(0,0),to:Pos(0,1),by:1},{from:Pos(0,0),to:Pos(0,0),by:-1,hitSide:true},{from:Pos(0,0),to:Pos(0,4),by:1,unit:"word"},{from:Pos(0,0),to:Pos(0,8),by:2,unit:"word"},{from:Pos(0,0),to:Pos(2,0),by:20,unit:"word",hitSide:true},{from:Pos(0,7),to:Pos(0,5),by:-1,unit:"word"},{from:Pos(0,4),to:Pos(0,8),by:1,unit:"word"},{from:Pos(1,0),to:Pos(1,18),by:3,unit:"word"},{from:Pos(1,22),to:Pos(1,5),by:-3,unit:"word"},{from:Pos(1,15),to:Pos(1,10),by:-5},{from:Pos(1,15),to:Pos(1,10),by:-5,unit:"column"},{from:Pos(1,15),to:Pos(1,0),by:-50,unit:"column",hitSide:true},{from:Pos(1,15),to:Pos(1,24),by:50,unit:"column",hitSide:true},{from:Pos(1,15),to:Pos(2,0),by:50,hitSide:true}],function(t){var n=e.findPosH(t.from,t.by,t.unit||"char");eqPos(n,t.to);eq(!!n.hitSide,!!t.hitSide)})},{value:"line one\nline two.something.other\n"});testCM("beforeChange",function(e){e.on("beforeChange",function(e,t){var n=[];for(var r=0;r<t.text.length;++r)n.push(t.text[r].replace(/\s/g,"_"));t.update(null,null,n)});e.setValue("hello, i am a\nnew document\n");eq(e.getValue(),"hello,_i_am_a\nnew_document\n");CodeMirror.on(e.getDoc(),"beforeChange",function(e,t){if(t.from.line==0)t.cancel()});e.setValue("oops");eq(e.getValue(),"hello,_i_am_a\nnew_document\n");e.replaceRange("hey hey hey",Pos(1,0),Pos(2,0));eq(e.getValue(),"hello,_i_am_a\nhey_hey_hey")},{value:"abcdefghijk"});testCM("beforeChangeUndo",function(e){e.replaceRange("hi",Pos(0,0),Pos(0));e.replaceRange("bye",Pos(0,0),Pos(0));eq(e.historySize().undo,2);e.on("beforeChange",function(e,t){is(!t.update);t.cancel()});e.undo();eq(e.historySize().undo,0);eq(e.getValue(),"bye\ntwo")},{value:"one\ntwo"});testCM("beforeSelectionChange",function(e){function t(e,t){var n=e.getLine(t.line).length;if(!n||t.ch==n)return Pos(t.line,t.ch-1);return t}e.on("beforeSelectionChange",function(e,n){n.update([{anchor:t(e,n.ranges[0].anchor),head:t(e,n.ranges[0].head)}])});addDoc(e,10,10);e.execCommand("goLineEnd");eqPos(e.getCursor(),Pos(0,9));e.execCommand("selectAll");eqPos(e.getCursor("start"),Pos(0,0));eqPos(e.getCursor("end"),Pos(9,9))});testCM("change_removedText",function(e){e.setValue("abc\ndef");var t=[];e.on("change",function(e,n){t.push(n.removed)});e.operation(function(){e.replaceRange("xyz",Pos(0,0),Pos(1,1));e.replaceRange("123",Pos(0,0))});eq(t.length,2);eq(t[0].join("\n"),"abc\nd");eq(t[1].join("\n"),"");var t=[];e.undo();eq(t.length,2);eq(t[0].join("\n"),"123");eq(t[1].join("\n"),"xyz");var t=[];e.redo();eq(t.length,2);eq(t[0].join("\n"),"abc\nd");eq(t[1].join("\n"),"")});testCM("lineStyleFromMode",function(e){CodeMirror.defineMode("test_mode",function(){return{token:function(e){if(e.match(/^\[[^\]]*\]/))return"  line-brackets  ";if(e.match(/^\([^\)]*\)/))return"  line-background-parens  ";if(e.match(/^<[^>]*>/))return"  span  line-line  line-background-bg  ";e.match(/^\s+|^\S+/)}}});e.setOption("mode","test_mode");var t=byClassName(e.getWrapperElement(),"brackets");eq(t.length,1,"brackets count");eq(t[0].nodeName,"PRE");is(!/brackets.*brackets/.test(t[0].className));var n=byClassName(e.getWrapperElement(),"parens");eq(n.length,1,"parens count");eq(n[0].nodeName,"DIV");is(!/parens.*parens/.test(n[0].className));eq(n[0].parentElement.nodeName,"DIV");eq(byClassName(e.getWrapperElement(),"bg").length,1);eq(byClassName(e.getWrapperElement(),"line").length,1);var r=byClassName(e.getWrapperElement(),"cm-span");eq(r.length,2);is(/^\s*cm-span\s*$/.test(r[0].className))},{value:"line1: [br] [br]\nline2: (par) (par)\nline3: <tag> <tag>"});CodeMirror.registerHelper("xxx","a","A");CodeMirror.registerHelper("xxx","b","B");CodeMirror.defineMode("yyy",function(){return{token:function(e){e.skipToEnd()},xxx:["a","b","q"]}});CodeMirror.registerGlobalHelper("xxx","c",function(e){return e.enableC},"C");testCM("helpers",function(e){e.setOption("mode","yyy");eq(e.getHelpers(Pos(0,0),"xxx").join("/"),"A/B");e.setOption("mode",{name:"yyy",modeProps:{xxx:"b",enableC:true}});eq(e.getHelpers(Pos(0,0),"xxx").join("/"),"B/C");e.setOption("mode","javascript");eq(e.getHelpers(Pos(0,0),"xxx").join("/"),"")});testCM("selectionHistory",function(e){for(var t=0;t<3;t++){e.setExtending(true);e.execCommand("goCharRight");e.setExtending(false);e.execCommand("goCharRight");e.execCommand("goCharRight")}e.execCommand("undoSelection");eq(e.getSelection(),"c");e.execCommand("undoSelection");eq(e.getSelection(),"");eqPos(e.getCursor(),Pos(0,4));e.execCommand("undoSelection");eq(e.getSelection(),"b");e.execCommand("redoSelection");eq(e.getSelection(),"");eqPos(e.getCursor(),Pos(0,4));e.execCommand("redoSelection");eq(e.getSelection(),"c");e.execCommand("redoSelection");eq(e.getSelection(),"");eqPos(e.getCursor(),Pos(0,6))},{value:"a b c d"});testCM("selectionChangeReducesRedo",function(e){e.replaceSelection("X");e.execCommand("goCharRight");e.undoSelection();e.execCommand("selectAll");e.undoSelection();eq(e.getValue(),"Xabc");eqPos(e.getCursor(),Pos(0,1));e.undoSelection();eq(e.getValue(),"abc")},{value:"abc"});testCM("selectionHistoryNonOverlapping",function(e){e.setSelection(Pos(0,0),Pos(0,1));e.setSelection(Pos(0,2),Pos(0,3));e.execCommand("undoSelection");eqPos(e.getCursor("anchor"),Pos(0,0));eqPos(e.getCursor("head"),Pos(0,1))},{value:"1234"});testCM("cursorMotionSplitsHistory",function(e){e.replaceSelection("a");e.execCommand("goCharRight");e.replaceSelection("b");e.replaceSelection("c");e.undo();eq(e.getValue(),"a1234");eqPos(e.getCursor(),Pos(0,2));e.undo();eq(e.getValue(),"1234");eqPos(e.getCursor(),Pos(0,0))},{value:"1234"});testCM("selChangeInOperationDoesNotSplit",function(e){for(var t=0;t<4;t++){e.operation(function(){e.replaceSelection("x");e.setCursor(Pos(0,e.getCursor().ch-1))})}eqPos(e.getCursor(),Pos(0,0));eq(e.getValue(),"xxxxa");e.undo();eq(e.getValue(),"a")},{value:"a"});testCM("alwaysMergeSelEventWithChangeOrigin",function(e){e.replaceSelection("U",null,"foo");e.setSelection(Pos(0,0),Pos(0,1),{origin:"foo"});e.undoSelection();eq(e.getValue(),"a");e.replaceSelection("V",null,"foo");e.setSelection(Pos(0,0),Pos(0,1),{origin:"bar"});e.undoSelection();eq(e.getValue(),"Va")},{value:"a"})